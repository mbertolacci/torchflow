<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Train a conditional flow model — train_conditional_flow • torchflow</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Train a conditional flow model — train_conditional_flow"><meta name="description" content="Method to train a conditional flow model. This is a basic training loop with
the following steps:"><meta property="og:description" content="Method to train a conditional flow model. This is a basic training loop with
the following steps:"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">torchflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/torchflow.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Train a conditional flow model</h1>

      <div class="d-none name"><code>train_conditional_flow.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Method to train a conditional flow model. This is a basic training loop with
the following steps:</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">train_conditional_flow</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  <span class="va">generate</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html" class="external-link">optim_adam</a></span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">128</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">32</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-model">model<a class="anchor" aria-label="anchor" href="#arg-model"></a></dt>
<dd><p>A conditional flow model inheriting from <code><a href="nn_conditional_flow.html">nn_conditional_flow()</a></code>.</p></dd>


<dt id="arg-generate">generate<a class="anchor" aria-label="anchor" href="#arg-generate"></a></dt>
<dd><p>A function that generates a batch of target and conditioning
samples; see above for details. This will be passed the current epoch number
as an argument.</p></dd>


<dt id="arg-optimizer">optimizer<a class="anchor" aria-label="anchor" href="#arg-optimizer"></a></dt>
<dd><p>The optimizer to use, e.g. <code><a href="https://rdrr.io/pkg/torch/man/optim_adam.html" class="external-link">torch::optim_adam()</a></code>.</p></dd>


<dt id="arg-n-epochs">n_epochs<a class="anchor" aria-label="anchor" href="#arg-n-epochs"></a></dt>
<dd><p>The number of epochs to train for.</p></dd>


<dt id="arg-batch-size">batch_size<a class="anchor" aria-label="anchor" href="#arg-batch-size"></a></dt>
<dd><p>The batch size.</p></dd>


<dt id="arg-after-epoch">after_epoch<a class="anchor" aria-label="anchor" href="#arg-after-epoch"></a></dt>
<dd><p>A function to call after each epoch.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Whether to print progress.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments to pass to the optimizer.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The training algorithm is as follows. For each epoch:</p><ol><li><p>Generate (using <code>generate</code>) a batch of target and conditioning samples.</p></li>
<li><p>Loop over the batches of the epoch, performing a gradient descent step
for each batch. The batches are processed in order from the generated
samples.</p></li>
<li><p>Call <code>after_epoch</code> (if provided) with the current epoch and the generated
samples. This can be used to print test loss or any other tasks.</p></li>
</ol><p>The <code>generate</code> function (called with the current epoch number as an argument)
should return a list with the following elements:</p><ul><li><p><code>target</code>: An <code><a href="https://rdrr.io/r/base/array.html" class="external-link">array()</a></code>, <code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix()</a></code>, or <code><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch::torch_tensor()</a></code> of target
samples.</p></li>
<li><p><code>conditioning</code>: An optional <code><a href="https://rdrr.io/r/base/array.html" class="external-link">array()</a></code>, <code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix()</a></code>, or <code><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch::torch_tensor()</a></code>
of conditioning samples.
If returning <code><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor()</a></code> objects, take care that they are on the same
device as the model.</p></li>
</ul><p>The generated samples are the choice of the user. You could generate new
samples each epoch, or share the same samples across epochs (noting that
the model may overfit in this case). In that latter case, it would be good
to permute the order of the samples each epoch.</p>
<p>The training may be stopped early. The original model object is modified in
place.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span>input_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="fu"><a href="nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span>input_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  <span class="fu"><a href="nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span>input_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">generate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">epoch</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>target <span class="op">=</span> <span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1024</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="co"># In practice, the number of epochs should be larger</span></span></span>
<span class="r-in"><span><span class="fu">train_conditional_flow</span><span class="op">(</span><span class="va">model</span>, <span class="va">generate</span>, n_epochs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> = Starting epoch 1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> = Starting epoch 2 </span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Bertolacci.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

