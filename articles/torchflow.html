<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>torchflow: Normalizing Flows using R torch • torchflow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="torchflow: Normalizing Flows using R torch">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">torchflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/torchflow.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>torchflow: Normalizing Flows using R torch</h1>
            
      

      <div class="d-none name"><code>torchflow.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mbertolacci.github.io/torchflow/">torchflow</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><strong>Give mathematical details</strong></p>
</div>
<div class="section level2">
<h2 id="creating-and-sampling-from-a-flow">Creating and sampling from a flow<a class="anchor" aria-label="anchor" href="#creating-and-sampling-from-a-flow"></a>
</h2>
<p>A simple two parameter normalising flow can be created as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This flow has five layers, which alternate between affine coupling
blocks and permutation flows. The flow is just a standard torch
<code>nn_module</code> and can be used in the usual way:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">flow_model</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.7620  1.2287</span></span>
<span><span class="co">#&gt;  0.7782  0.1347</span></span>
<span><span class="co">#&gt; -0.3300 -1.9583</span></span>
<span><span class="co">#&gt;  0.2246  0.6583</span></span>
<span><span class="co">#&gt; -0.4207 -0.2339</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,2} ][ grad_fn = &lt;CatBackward0&gt; ]</span></span></code></pre></div>
<p>The first dimension of the input acts as a batch dimension, so the
flow can be used to generate multiple samples at once. The above code
actually implements sampling from the distribution represented by the
flow. This can also be done directly using the
<code>generate_from_conditional_flow</code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.0049 -1.2907</span></span>
<span><span class="co">#&gt; -0.6298  1.8716</span></span>
<span><span class="co">#&gt; -0.9137  0.9934</span></span>
<span><span class="co">#&gt; -1.2454  2.2633</span></span>
<span><span class="co">#&gt;  0.3215 -1.1245</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,2} ][ grad_fn = &lt;ReshapeAliasBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conditional-flow">Conditional flow<a class="anchor" aria-label="anchor" href="#conditional-flow"></a>
</h2>
<p>A conditional flow takes an additional input, the conditioning
variable, which can be used to condition the samples on some additional
information. The flow therefore encodes a conditional distribution. The
following code creates a conditional flow with the same architecture as
the unconditional flow defined above but with an additional conditioning
variable of dimension 3:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conditioned_flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can sample from the flow for a given conditioning variable as
follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conditioning</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">conditioned_flow_model</span>, <span class="fl">5</span>, <span class="va">conditioning</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.8864 -0.4017</span></span>
<span><span class="co">#&gt; -2.3727 -0.4412</span></span>
<span><span class="co">#&gt; -1.2729  0.7148</span></span>
<span><span class="co">#&gt;  0.8890 -0.3691</span></span>
<span><span class="co">#&gt; -0.0843  1.4628</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,2} ][ grad_fn = &lt;ReshapeAliasBackward0&gt; ]</span></span></code></pre></div>
<p>We can also do this for a batch of conditioning variables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conditioning</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">conditioned_flow_model</span>, <span class="fl">5</span>, <span class="va">conditioning</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; (1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.5824 -0.0515</span></span>
<span><span class="co">#&gt;  -0.9207  0.8802</span></span>
<span><span class="co">#&gt;   1.4992  0.8227</span></span>
<span><span class="co">#&gt;   1.5624  0.6627</span></span>
<span><span class="co">#&gt;   0.4472  0.9105</span></span>
<span><span class="co">#&gt;   0.6486 -1.1479</span></span>
<span><span class="co">#&gt;  -1.1329  1.1935</span></span>
<span><span class="co">#&gt;   0.4598  0.3404</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (2,.,.) = </span></span>
<span><span class="co">#&gt;   0.0424  0.3839</span></span>
<span><span class="co">#&gt;  -1.3179 -1.0277</span></span>
<span><span class="co">#&gt;   0.4484 -0.7403</span></span>
<span><span class="co">#&gt;  -1.2641 -0.6590</span></span>
<span><span class="co">#&gt;   1.1145  0.1883</span></span>
<span><span class="co">#&gt;   0.3371 -0.1862</span></span>
<span><span class="co">#&gt;   1.7885  0.0867</span></span>
<span><span class="co">#&gt;  -0.0099 -0.0765</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (3,.,.) = </span></span>
<span><span class="co">#&gt;   0.3426  1.5401</span></span>
<span><span class="co">#&gt;   0.5718 -0.1705</span></span>
<span><span class="co">#&gt;   0.6092  1.1342</span></span>
<span><span class="co">#&gt;   0.6860 -1.2105</span></span>
<span><span class="co">#&gt;  -0.1089 -0.1245</span></span>
<span><span class="co">#&gt;  -2.2699  0.2824</span></span>
<span><span class="co">#&gt;   0.7406 -0.6958</span></span>
<span><span class="co">#&gt;  -0.4172 -0.5103</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,8,2} ][ grad_fn = &lt;ReshapeAliasBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="training-an-unconditional-flow">Training an unconditional flow<a class="anchor" aria-label="anchor" href="#training-an-unconditional-flow"></a>
</h2>
<p>The above flows are randomly initialised, so samples from them do not
follow any interesting distribution. We can instead train a flow to
follow a given distribution using samples from that distribution.</p>
<p>Let us train a flow to match the following distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>∼</mo><msup><mi>N</mi><mo>+</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma \sim N^+(0, 1)</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu \sim N(0, \sigma^2)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>N</mi><mo>+</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N^+(0, 1)</annotation></semantics></math>
is the half normal distribution with mean 0 and standard deviation 1. We
can generate samples from this distribution as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span> <span class="op">*</span> <span class="va">sigma</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">generate_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $target</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -2.0356e+00  2.1848e+00</span></span>
<span><span class="co">#&gt; -3.7028e-01  1.0502e+00</span></span>
<span><span class="co">#&gt;  2.0638e-01  3.1134e-01</span></span>
<span><span class="co">#&gt; -2.4274e-01  2.6957e-01</span></span>
<span><span class="co">#&gt;  9.6417e-01  1.9926e+00</span></span>
<span><span class="co">#&gt;  2.8992e-05  7.1465e-05</span></span>
<span><span class="co">#&gt;  2.9896e+00  2.1187e+00</span></span>
<span><span class="co">#&gt; -7.3388e-01  1.1435e+00</span></span>
<span><span class="co">#&gt;  4.0176e-01  1.3425e+00</span></span>
<span><span class="co">#&gt;  5.4139e-01  1.3120e+00</span></span>
<span><span class="co">#&gt; -1.5147e-01  4.8527e-01</span></span>
<span><span class="co">#&gt; -9.3724e-01  4.3965e-01</span></span>
<span><span class="co">#&gt;  1.3770e-01  6.4735e-02</span></span>
<span><span class="co">#&gt; -3.9224e-01  8.1522e-01</span></span>
<span><span class="co">#&gt; -1.6318e-01  2.3478e-01</span></span>
<span><span class="co">#&gt;  8.5131e-02  1.9225e-01</span></span>
<span><span class="co">#&gt; -3.9256e-01  4.5994e-01</span></span>
<span><span class="co">#&gt; -1.0516e-01  2.0527e-01</span></span>
<span><span class="co">#&gt; -4.7685e-01  5.4539e-01</span></span>
<span><span class="co">#&gt; -3.2769e-01  3.9091e-01</span></span>
<span><span class="co">#&gt;  2.1266e-01  1.0014e-01</span></span>
<span><span class="co">#&gt; -4.2534e-02  3.2324e-02</span></span>
<span><span class="co">#&gt; -7.7913e-01  9.7084e-01</span></span>
<span><span class="co">#&gt;  2.3862e-01  1.0406e+00</span></span>
<span><span class="co">#&gt;  3.5122e-02  1.4570e-01</span></span>
<span><span class="co">#&gt;  6.5700e-01  8.9683e-01</span></span>
<span><span class="co">#&gt; -2.0690e+00  1.9685e+00</span></span>
<span><span class="co">#&gt;  1.4820e+00  8.5359e-01</span></span>
<span><span class="co">#&gt; -6.9395e-01  1.1226e+00</span></span>
<span><span class="co">#&gt;  1.9841e+00  1.8730e+00</span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1024,2} ]</span></span></code></pre></div>
<p>This function can be used to train the flow to match the distribution
using the <code>train_conditional_flow</code> function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">flow_model</span>,</span>
<span>  <span class="va">generate_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">32</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">256</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">flow_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 0.5469023 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 0.2499641 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: 0.1619004 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: 0.1500571 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: 0.0622198 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: 0.02612031 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: -0.007688463 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: -0.04603517 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: -0.1078135 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: -0.1059128 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: -0.1240132 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: -0.111249 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: -0.1626916 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: -0.1532276 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: -0.1728297 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -0.1788442 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -0.1835951 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -0.1981164 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -0.1863381 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -0.2018799 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -0.1780871 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -0.1862966 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -0.1865796 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -0.2016056 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -0.2185627 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -0.1756115 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -0.1658197 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -0.1506733 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -0.2066042 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -0.2044319 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -0.2119279 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -0.1880534</span></span></code></pre></div>
<p>It looks as though the test loss has converged. We can sample from
the trained flow as follows and compare the samples to the test set:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">1024</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, ylab <span class="op">=</span> <span class="st">'sigma'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>This looks like a reasonable approximation to the target
distribution. We can also look at marginal histograms:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Target'</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Samples'</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Target'</span>, xlab <span class="op">=</span> <span class="st">'sigma'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'Samples'</span>, xlab <span class="op">=</span> <span class="st">'sigma'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<p>These look okay.</p>
</div>
<div class="section level2">
<h2 id="training-a-conditional-flow">Training a conditional flow<a class="anchor" aria-label="anchor" href="#training-a-conditional-flow"></a>
</h2>
<p>The process for training a conditional flow is the same as for an
unconditional flow, except that the <code>generate</code> function now
also returns the conditioning variable. Let’s add a conditioning
variable,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y \sim N(\mu, \sigma^2)</annotation></semantics></math>,
with four replicates:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_conditional_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span> <span class="op">*</span> <span class="va">sigma</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    conditioning <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">conditioning_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_conditional_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ target      :Float [1:1024, 1:2]</span></span>
<span><span class="co">#&gt;  $ conditioning:Float [1:1024, 1:4]</span></span>
<span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">conditioning_flow</span>,</span>
<span>  <span class="va">generate_conditional_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">128</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">256</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">conditioning_flow</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 0.01622194 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: -0.1600565 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: -0.433969 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: -0.6365002 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: -0.6937561 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: -0.7636083 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: -0.9626853 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: -1.137826 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: -1.25346 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: -1.341025 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: -1.354002 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: -1.411517 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: -1.455572 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: -1.492022 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: -1.52513 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -1.549721 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -1.547466 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -1.596376 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -1.605451 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -1.622974 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -1.628625 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -1.64203 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -1.665685 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -1.634296 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -1.668058 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -1.69806 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -1.716853 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -1.70732 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -1.744259 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -1.769782 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -1.769986 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -1.761097 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: -1.78656 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: -1.797829 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: -1.786608 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: -1.823979 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: -1.830046 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: -1.831178 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: -1.822447 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: -1.846764 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: -1.864379 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: -1.852462 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: -1.820471 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: -1.851835 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: -1.900735 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: -1.881277 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: -1.881364 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: -1.910052 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: -1.920465 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: -1.914604 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: -1.947809 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: -1.929116 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: -1.927137 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: -1.959081 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: -1.955928 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: -1.899044 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: -1.941839 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: -1.952915 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: -1.95999 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: -1.932041 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: -1.925941 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: -1.94037 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: -1.96522 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: -1.953818 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: -1.938549 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: -1.944006 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: -1.961961 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: -1.94028 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: -1.974152 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: -1.979357 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: -1.982947 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: -1.96897 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: -1.97713 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: -1.999575 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: -1.992031 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: -1.999038 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: -1.993555 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: -1.977866 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: -2.0021 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: -1.992567 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: -1.983955 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: -2.008642 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: -2.019134 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: -2.012392 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: -1.98646 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: -1.977364 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: -2.000924 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: -2.011215 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: -2.023432 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: -1.993426 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: -1.982684 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: -1.963305 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: -1.95559 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: -2.009637 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: -1.989193 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: -1.971342 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: -1.988139 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: -2.002418 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: -2.000582 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: -2.017789 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: -2.044932 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: -2.039354 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: -2.026986 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: -2.018082 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: -1.980145 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: -2.012449 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: -1.972013 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: -1.997239 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: -2.009499 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: -2.026279 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: -2.020371 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: -2.027358 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: -2.004359 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: -2.000253 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: -2.011775 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: -2.023753 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: -2.018657 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: -2.017733 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: -1.993375 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: -2.021626 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: -2.044446 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: -2.043306 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: -1.983582 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: -2.016671 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: -1.99425 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: -1.989632 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: -2.016616 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: -2.018335</span></span></code></pre></div>
<p>We can generate samples from the trained flow as follows, where now
the samples are conditioned on the values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate 1024 samples for each of the first 4 conditioning variables in the test set</span></span>
<span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">conditioning_flow</span>, <span class="fl">1024</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'sigma'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
<p>We can also plot the samples on a scatter plot:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, ylab <span class="op">=</span> <span class="st">'sigma'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-14-1.png" width="768"></p>
<p><strong>Compare these to MCMC</strong></p>
</div>
<div class="section level2">
<h2 id="using-a-summarizing-network">Using a summarizing network<a class="anchor" aria-label="anchor" href="#using-a-summarizing-network"></a>
</h2>
<p>In the above example, the conditioning variable <code>y</code>
contains four replicates of the conditioning variable. We ignored the
fact that these are replicates, and the trained the flow as though they
could be dependent. We can instead use a summarizing network that
individually processes each individual replicate into a set of summary
statistics, and then combine the summary statistics in a permutation
invariant way to form the conditioning variable. Here is an example
summarizing network:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summarizing_network</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">summary_head</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">summaries</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">summary_head</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">y</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_sum.html" class="external-link">torch_sum</a></span><span class="op">(</span><span class="va">summaries</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_model</span> <span class="op">&lt;-</span> <span class="fu">summarizing_network</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">summary_model</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.7071 -0.4450  0.8973  0.8394  0.6094 -1.7677 -0.4467 -1.6985</span></span>
<span><span class="co">#&gt; -1.2254 -0.4747  0.8935  1.4770 -0.1325 -1.8353 -0.9247 -2.7288</span></span>
<span><span class="co">#&gt; -0.9723 -0.5416  0.8720  1.2070  0.1392 -1.8230 -0.8471 -2.1256</span></span>
<span><span class="co">#&gt; -0.7188 -0.4634  0.8998  0.8513  0.5863 -1.7680 -0.4688 -1.6968</span></span>
<span><span class="co">#&gt; -1.2502 -0.4745  0.8584  1.4739 -0.1680 -1.8842 -0.9474 -2.7824</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,8} ][ grad_fn = &lt;SumBackward1&gt; ]</span></span></code></pre></div>
<p>We can combine the summarizing network with the flow in a
<code>nn_summarizing_conditional_flow</code> object:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">conditioning_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_summarizing_conditional_flow.html">nn_summarizing_conditional_flow</a></span><span class="op">(</span><span class="va">summary_model</span>, <span class="va">flow_model</span><span class="op">)</span></span></code></pre></div>
<p>Let’s also expand the number of replicated observations to 32:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_conditional_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span> <span class="op">*</span> <span class="va">sigma</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    conditioning <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s train the model:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_conditional_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ target      :Float [1:1024, 1:2]</span></span>
<span><span class="co">#&gt;  $ conditioning:Float [1:1024, 1:32]</span></span>
<span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">conditioning_flow</span>,</span>
<span>  <span class="va">generate_conditional_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">128</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">256</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">conditioning_flow</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 2.527285 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 0.272491 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: -1.10597 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: -1.606657 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: -1.878848 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: -2.186857 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: -2.120122 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: -2.487521 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: -2.417301 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: -2.713473 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: -2.716826 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: -2.929903 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: -2.868973 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: -3.040671 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: -3.081934 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -3.137375 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -3.179258 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -3.301177 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -3.340478 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -3.401419 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -3.246785 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -3.316793 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -3.418037 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -3.470295 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -3.461064 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -3.50052 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -3.466089 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -3.484479 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -3.478055 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -3.436536 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -3.312264 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -3.392005 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: -3.554828 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: -3.498564 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: -3.470842 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: -3.570588 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: -3.553841 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: -3.50714 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: -3.521438 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: -3.502527 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: -3.485194 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: -3.458437 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: -3.500523 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: -3.55771 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: -3.622029 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: -3.655207 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: -3.658111 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: -3.701914 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: -3.742097 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: -3.674263 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: -3.650943 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: -3.664033 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: -3.608829 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: -3.687944 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: -3.736233 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: -3.664591 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: -3.735357 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: -3.722732 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: -3.747531 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: -3.730324 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: -3.635703 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: -3.712051 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: -3.73139 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: -3.635473 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: -3.765982 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: -3.720483 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: -3.77317 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: -3.612534 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: -3.78901 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: -3.550354 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: -3.592261 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: -3.755776 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: -3.484489 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: -3.711726 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: -3.778238 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: -3.756815 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: -3.773376 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: -3.740174 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: -3.783231 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: -3.439708 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: -3.623181 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: -3.578712 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: -3.76767 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: -3.692988 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: -3.743431 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: -3.669569 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: -3.70144 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: -3.713464 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: -3.753165 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: -3.746385 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: -3.7517 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: -3.480921 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: -3.635423 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: -3.72131 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: -3.737788 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: -3.784837 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: -3.795456 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: -3.781871 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: -3.652484 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: -3.669938 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: -3.80552 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: -3.783965 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: -3.703072 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: -3.759994 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: -3.812117 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: -3.797255 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: -3.802492 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: -3.76484 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: -3.829921 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: -3.840332 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: -3.816914 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: -3.792278 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: -3.722486 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: -3.774091 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: -3.814323 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: -3.787137 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: -3.784008 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: -3.793586 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: -3.830618 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: -3.723323 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: -3.819359 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: -3.674448 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: -3.740015 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: -3.755173 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: -3.842011 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: -3.859711 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: -3.846105 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: -3.729074</span></span></code></pre></div>
<p>We can generate samples from the trained model as before:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate 1024 samples for each of the first 4 conditioning variables in the test set</span></span>
<span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">conditioning_flow</span>, <span class="fl">1024</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'sigma'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-19-1.png" width="768"></p>
<p>We can also plot the samples on a scatter plot:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, ylab <span class="op">=</span> <span class="st">'sigma'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-20-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="more-complex-conditioning-variables">More complex conditioning variables<a class="anchor" aria-label="anchor" href="#more-complex-conditioning-variables"></a>
</h2>
<p>The summarizing network is the key to using more complex conditioning
variables. For example, we can use a 2D grid of points as the
conditioning variable, which is processed by the summarizing network
into a set of summary statistics which are then used as the conditioning
variable for the flow. For the 2-D grid, a convolutional network is a
conventional choice that often works well in practice.</p>
<p>The following example generates data using an exponential covariance
with unknown variance and length scale over a 16x16 2-D grid:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_grid</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">x_y_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_grid</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_grid</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">x_y_grid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">generate_conditional_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">ell</span> <span class="op">&lt;-</span> <span class="fl">0.1</span> <span class="op">+</span> <span class="fl">1.9</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_rand.html" class="external-link">torch_rand</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_square.html" class="external-link">torch_square</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_exp.html" class="external-link">torch_exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">distances</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="va">ell</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">L</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/linalg_cholesky.html" class="external-link">linalg_cholesky</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span></span>
<span>  <span class="va">y_flat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_matmul.html" class="external-link">torch_matmul</a></span><span class="op">(</span><span class="va">L</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">256</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># The extra 1 here is interpreted as a single channel</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_reshape.html" class="external-link">torch_reshape</a></span><span class="op">(</span><span class="va">y_flat</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">1</span>, <span class="va">n_grid</span>, <span class="va">n_grid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># We log the parameters to ensure they have real support;</span></span>
<span>    <span class="co"># this is not strictly necessary for the flow to work, but it</span></span>
<span>    <span class="co"># does make it easier to match the distribution</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_log.html" class="external-link">torch_log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ell</span>, <span class="va">sigma</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    conditioning <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_conditional_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span>, , <span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'x'</span>, ylab <span class="op">=</span> <span class="st">'y'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-21-1.png" width="768"></p>
<p>We can now create a summarizing network for this conditioning
variable. A convolutional network is a conventional choice for this type
of data. The network alternates between convolution, ReLU and max
pooling layers, with a final adaptive average pooling layer to reduce
the summary statistics to a fixed size vector of dimension 32 (the
number of summary statistics used by the flow):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span>, <span class="fl">3</span>, padding <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool2d.html" class="external-link">nn_max_pool2d</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">32</span>, <span class="fl">3</span>, padding <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_adaptive_avg_pool2d.html" class="external-link">nn_adaptive_avg_pool2d</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_flatten.html" class="external-link">nn_flatten</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">summary_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">10</span>, , , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Float [1:10, 1:32]</span></span></code></pre></div>
<p>We can now create a conditional flow with this summarizing
network:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">32</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">conditioning_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_summarizing_conditional_flow.html">nn_summarizing_conditional_flow</a></span><span class="op">(</span><span class="va">summary_model</span>, <span class="va">flow_model</span><span class="op">)</span></span></code></pre></div>
<p>We can now train the model as before:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">conditioning_flow</span>,</span>
<span>  <span class="va">generate_conditional_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">128</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">conditioning_flow</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 0.9148552 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 0.8257918 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: 0.76542 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: 0.7236527 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: 0.6900516 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: 0.6569164 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: 0.6210347 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: 0.5757983 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: 0.5162966 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: 0.4483618 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: 0.3765357 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: 0.3034223 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: 0.2256234 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: 0.1406085 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: 0.0433929 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -0.06104606 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -0.1640665 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -0.2555541 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -0.3497666 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -0.4393754 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -0.5053609 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -0.4949403 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -0.612844 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -0.5932434 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -0.6804665 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -0.4698762 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -0.7435459 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -0.7038008 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -0.8489974 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -0.769849 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -0.7708951 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -0.9687425 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: -0.9050489 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: -1.019698 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: -1.045637 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: -0.9476085 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: -1.161181 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: -1.138703 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: -1.20327 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: -1.252636 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: -1.238665 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: -1.361016 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: -1.345004 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: -1.4338 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: -1.405056 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: -1.461778 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: -1.521416 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: -1.504567 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: -1.605985 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: -1.579659 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: -1.658729 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: -1.64879 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: -1.712619 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: -1.747455 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: -1.770522 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: -1.794251 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: -1.801921 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: -1.74546 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: -1.647608 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: -1.857547 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: -1.780075 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: -1.615994 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: -1.903093 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: -1.679343 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: -1.79478 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: -1.818268 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: -1.737698 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: -1.936016 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: -1.83212 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: -1.961082 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: -1.819783 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: -1.972634 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: -1.924888 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: -1.979099 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: -1.969754 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: -1.937117 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: -2.049493 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: -1.893825 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: -2.032295 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: -2.045876 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: -1.976756 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: -2.092072 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: -1.947967 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: -2.081878 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: -2.046363 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: -2.057215 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: -2.13402 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: -2.018486 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: -2.082926 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: -2.118807 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: -1.909981 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: -2.007208 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: -2.111677 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: -1.874924 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: -2.113178 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: -2.046612 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: -2.03427 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: -2.13606 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: -2.064483 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: -2.160323 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: -2.06707 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: -2.165398 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: -2.072236 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: -2.178817 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: -2.085823 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: -2.178226 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: -2.19351 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: -2.082016 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: -2.197536 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: -2.201848 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: -2.188328 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: -2.258529 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: -2.236154 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: -2.240849 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: -2.257506 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: -2.236174 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: -2.238575 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: -2.280871 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: -2.267398 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: -2.269904 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: -2.291243 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: -2.252173 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: -2.285157 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: -2.302592 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: -2.298436 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: -2.258844 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: -2.261136 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: -2.240029</span></span></code></pre></div>
<p>We can now generate samples from the trained model:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">conditioning_flow</span>, <span class="fl">1024</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span>, , , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:1024, 1:4, 1:2] 0.119 -0.153 -1.035 0.141 0.444 ...</span></span>
<span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'ell'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'sigma'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-25-1.png" width="768"></p>
<p>We can also plot the samples on a scatter plot:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'ell'</span>, ylab <span class="op">=</span> <span class="st">'sigma'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-26-1.png" width="768"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Bertolacci.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
