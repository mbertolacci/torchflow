<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>torchflow • torchflow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="torchflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">torchflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/torchflow.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>torchflow</h1>
            
      

      <div class="d-none name"><code>torchflow.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mbertolacci.github.io/torchflow/">torchflow</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>This vignette is still under construction</em></p>
<p><strong>Give mathematical details of normalizing flows</strong></p>
</div>
<div class="section level2">
<h2 id="creating-and-sampling-from-a-flow">Creating and sampling from a flow<a class="anchor" aria-label="anchor" href="#creating-and-sampling-from-a-flow"></a>
</h2>
<p>A simple two parameter normalising flow can be created as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This flow has five layers, which alternate between affine coupling
blocks and permutation flows. The flow is just a standard torch
<code>nn_module</code> and can be used in the usual way:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">flow_model</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -2.4040 -0.3088</span></span>
<span><span class="co">#&gt;  0.4165  0.5813</span></span>
<span><span class="co">#&gt;  0.9275  1.2054</span></span>
<span><span class="co">#&gt;  1.0183 -0.5673</span></span>
<span><span class="co">#&gt; -0.4721  0.2499</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,2} ][ grad_fn = &lt;CatBackward0&gt; ]</span></span></code></pre></div>
<p>The first dimension of the input acts as a batch dimension, so the
flow can be used to generate multiple samples at once. The above code
actually implements sampling from the distribution represented by the
flow. This can also be done directly using the
<code>generate_from_conditional_flow</code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  0.2539  0.7570</span></span>
<span><span class="co">#&gt;  1.0137  1.1758</span></span>
<span><span class="co">#&gt;  0.2939 -1.0022</span></span>
<span><span class="co">#&gt;  0.5037  0.7455</span></span>
<span><span class="co">#&gt; -0.5975 -0.7554</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,2} ][ grad_fn = &lt;ReshapeAliasBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conditional-flow">Conditional flow<a class="anchor" aria-label="anchor" href="#conditional-flow"></a>
</h2>
<p>A conditional flow takes an additional input, the conditioning
variable, which can be used to condition the samples on some additional
information. The flow therefore encodes a conditional distribution. The
following code creates a conditional flow with the same architecture as
the unconditional flow defined above but with an additional conditioning
variable of dimension 3:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can sample from the flow for a given conditioning variable as
follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conditioning</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">5</span>, <span class="va">conditioning</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt;  1.3347  0.5075</span></span>
<span><span class="co">#&gt;  0.2563  0.2097</span></span>
<span><span class="co">#&gt; -1.5537  0.5951</span></span>
<span><span class="co">#&gt;  0.9271 -0.7754</span></span>
<span><span class="co">#&gt; -0.8416  0.3235</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,2} ][ grad_fn = &lt;ReshapeAliasBackward0&gt; ]</span></span></code></pre></div>
<p>We can also do this for a batch of conditioning variables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conditioning</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">5</span>, <span class="va">conditioning</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; (1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.0590 -0.3817</span></span>
<span><span class="co">#&gt;   0.7356 -0.6971</span></span>
<span><span class="co">#&gt;   0.8828 -0.1261</span></span>
<span><span class="co">#&gt;   0.9379 -0.6220</span></span>
<span><span class="co">#&gt;   1.3876 -0.6502</span></span>
<span><span class="co">#&gt;   0.4535  1.4878</span></span>
<span><span class="co">#&gt;  -1.4407 -0.2799</span></span>
<span><span class="co">#&gt;   0.0744 -2.2331</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (2,.,.) = </span></span>
<span><span class="co">#&gt;   1.4997  0.2495</span></span>
<span><span class="co">#&gt;   0.1092 -0.4803</span></span>
<span><span class="co">#&gt;  -0.1917 -0.0525</span></span>
<span><span class="co">#&gt;   0.5874 -0.6281</span></span>
<span><span class="co">#&gt;  -0.8792 -2.1344</span></span>
<span><span class="co">#&gt;   0.0894 -1.1348</span></span>
<span><span class="co">#&gt;   0.5266 -0.2800</span></span>
<span><span class="co">#&gt;  -2.6876  0.7953</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (3,.,.) = </span></span>
<span><span class="co">#&gt;   0.3694 -0.9087</span></span>
<span><span class="co">#&gt;   0.7843  2.3371</span></span>
<span><span class="co">#&gt;   0.1319 -1.1534</span></span>
<span><span class="co">#&gt;   1.2439  0.7528</span></span>
<span><span class="co">#&gt;  -0.1596 -0.0032</span></span>
<span><span class="co">#&gt;   0.1992  1.4269</span></span>
<span><span class="co">#&gt;   0.9183 -0.4541</span></span>
<span><span class="co">#&gt;  -1.0375 -1.4010</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{5,8,2} ][ grad_fn = &lt;ReshapeAliasBackward0&gt; ]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="training-an-unconditional-flow">Training an unconditional flow<a class="anchor" aria-label="anchor" href="#training-an-unconditional-flow"></a>
</h2>
<p>The above flows are randomly initialised, so samples from them do not
follow any interesting distribution. We can instead train a flow to
follow a given distribution using samples from that distribution.</p>
<p>Let us train a flow to match the following distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>∼</mo><msup><mi>N</mi><mo>+</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma \sim N^+(0, 1)</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu \sim N(0, \sigma^2)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>N</mi><mo>+</mo></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N^+(0, 1)</annotation></semantics></math>
is the half normal distribution with mean 0 and standard deviation 1. We
can generate samples from this distribution as follows. Note that we
take the logarithm of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
parameter to ensure that it has real support; the flow targets this
transformed distribution.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span> <span class="op">*</span> <span class="va">sigma</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_log.html" class="external-link">torch_log</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">generate_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $target</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.8667 -0.3827</span></span>
<span><span class="co">#&gt;  0.0365 -1.3413</span></span>
<span><span class="co">#&gt; -0.3181 -0.5935</span></span>
<span><span class="co">#&gt; -2.4126  0.3609</span></span>
<span><span class="co">#&gt; -0.0059 -2.0003</span></span>
<span><span class="co">#&gt;  0.7169  0.4706</span></span>
<span><span class="co">#&gt; -0.7395  0.7398</span></span>
<span><span class="co">#&gt; -0.7585 -0.1613</span></span>
<span><span class="co">#&gt;  0.1001  0.4163</span></span>
<span><span class="co">#&gt;  0.4853 -0.5087</span></span>
<span><span class="co">#&gt;  0.8954 -0.1740</span></span>
<span><span class="co">#&gt; -1.9402  0.5729</span></span>
<span><span class="co">#&gt;  0.1696  0.3833</span></span>
<span><span class="co">#&gt;  0.0653 -0.6502</span></span>
<span><span class="co">#&gt;  0.0744 -2.0966</span></span>
<span><span class="co">#&gt;  0.4775 -0.6799</span></span>
<span><span class="co">#&gt; -0.9345 -0.7387</span></span>
<span><span class="co">#&gt; -0.1083  0.0774</span></span>
<span><span class="co">#&gt; -0.3095  0.1133</span></span>
<span><span class="co">#&gt; -2.8573  0.1349</span></span>
<span><span class="co">#&gt;  0.0861 -1.0267</span></span>
<span><span class="co">#&gt; -0.9197 -0.2701</span></span>
<span><span class="co">#&gt; -0.1450 -1.0385</span></span>
<span><span class="co">#&gt;  0.2727 -0.0113</span></span>
<span><span class="co">#&gt;  0.6968 -0.4938</span></span>
<span><span class="co">#&gt;  0.2728  0.8436</span></span>
<span><span class="co">#&gt;  0.2511 -0.4979</span></span>
<span><span class="co">#&gt; -0.0994 -1.3053</span></span>
<span><span class="co">#&gt; -0.2987  0.2431</span></span>
<span><span class="co">#&gt;  1.2443  0.1593</span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{1024,2} ]</span></span></code></pre></div>
<p>This function can be used to train the flow to match the distribution
using the <code>train_conditional_flow</code> function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make an unconditional flow</span></span>
<span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate a test set</span></span>
<span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_samples</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train the flow</span></span>
<span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">flow_model</span>,</span>
<span>  <span class="va">generate_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">128</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">flow_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 0.9271869 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 0.8001457 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: 0.7488361 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: 0.6661429 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: 0.5962025 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: 0.5857441 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: 0.5662175 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: 0.5892022 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: 0.5762827 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: 0.5402798 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: 0.5047749 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: 0.4830003 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: 0.4646573 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: 0.4563828 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: 0.4572161 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: 0.4579548 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: 0.4485965 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: 0.442442 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: 0.4426354 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: 0.4388287 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: 0.4405272 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: 0.4359372 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: 0.429469 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: 0.4233651 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: 0.4234435 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: 0.4154094 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: 0.4070852 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: 0.3968915 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: 0.3860741 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: 0.3797366 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: 0.3744617 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: 0.3722309 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: 0.3653021 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: 0.3624367 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: 0.356658 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: 0.353855 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: 0.3517757 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: 0.3437041 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: 0.3440558 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: 0.3406034 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: 0.3436844 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: 0.3479714 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: 0.3414798 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: 0.3432663 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: 0.3487095 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: 0.3466508 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: 0.3598909 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: 0.3699676 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: 0.3390064 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: 0.3766879 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: 0.3569057 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: 0.3407454 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: 0.3663223 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: 0.3510813 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: 0.333999 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: 0.3658112 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: 0.3786381 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: 0.3526235 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: 0.3508323 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: 0.3455698 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: 0.3294594 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: 0.3392054 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: 0.348183 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: 0.3320436 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: 0.3281522 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: 0.3287125 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: 0.3255284 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: 0.3310428 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: 0.3453424 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: 0.3265154 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: 0.322819 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: 0.324812 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: 0.3328074 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: 0.3499305 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: 0.338149 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: 0.3297054 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: 0.3339036 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: 0.3271742 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: 0.3341535 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: 0.3640861 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: 0.3294095 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: 0.3277612 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: 0.3208331 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: 0.3307408 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: 0.3332303 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: 0.3285087 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: 0.3290081 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: 0.3300619 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: 0.3362264 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: 0.3501159 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: 0.3357137 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: 0.3269452 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: 0.3289945 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: 0.3235015 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: 0.3275851 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: 0.3238338 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: 0.3187591 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: 0.3186634 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: 0.3282628 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: 0.342284 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: 0.3261827 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: 0.3202139 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: 0.3254945 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: 0.3293313 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: 0.3371072 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: 0.3383129 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: 0.3327597 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: 0.3286009 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: 0.3291637 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: 0.324105 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: 0.3218752 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: 0.3267481 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: 0.3191612 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: 0.344999 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: 0.3350651 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: 0.3534442 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: 0.3337305 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: 0.3446874 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: 0.362094 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: 0.3484924 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: 0.3333991 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: 0.3329448 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: 0.3386364 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: 0.3382934 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: 0.3322574 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: 0.3329573 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: 0.3295634 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: 0.3278763</span></span></code></pre></div>
<p>It looks as though the test loss has converged. We can sample from
the trained flow as follows and compare the samples to the test set:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">1024</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">test_target</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, ylab <span class="op">=</span> <span class="st">'log(sigma)'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">test_samples</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>This looks like a reasonable approximation to the target
distribution. We can also look at marginal histograms:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">'Target'</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">'Samples'</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">'Target'</span>, xlab <span class="op">=</span> <span class="st">'log(sigma)'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">'Samples'</span>, xlab <span class="op">=</span> <span class="st">'log(sigma)'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<p>These look okay.</p>
</div>
<div class="section level2">
<h2 id="training-a-conditional-flow">Training a conditional flow<a class="anchor" aria-label="anchor" href="#training-a-conditional-flow"></a>
</h2>
<p>The process for training a conditional flow is the same as for an
unconditional flow, except that the <code>generate</code> function now
also returns the conditioning variable. Let’s add a conditioning
variable,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y \sim N(\mu, \sigma^2)</annotation></semantics></math>,
with four replicates:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_conditional_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span> <span class="op">*</span> <span class="va">sigma</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_log.html" class="external-link">torch_log</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    conditioning <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Make a conditional flow</span></span>
<span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate a test set</span></span>
<span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_conditional_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ target      :Float [1:1024, 1:2]</span></span>
<span><span class="co">#&gt;  $ conditioning:Float [1:1024, 1:4]</span></span>
<span></span>
<span><span class="co"># Train the flow</span></span>
<span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">flow_model</span>,</span>
<span>  <span class="va">generate_conditional_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">256</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">flow_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 0.9426878 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 0.6922643 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: 0.4695846 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: 0.2789893 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: 0.1546731 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: 0.09796298 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: 0.02712953 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: 0.002233922 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: -0.102133 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: -0.1581338 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: -0.2884604 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: -0.3400788 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: -0.3803951 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: -0.4104825 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: -0.4150733 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -0.4369184 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -0.5222591 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -0.615234 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -0.5938441 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -0.6172765 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -0.6741821 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -0.7165433 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -0.7126707 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -0.698045 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -0.7911004 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -0.6653016 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -0.7623352 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -0.869364 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -0.8083864 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -0.7648807 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -0.8723817 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -0.9734905 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: -0.9605322 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: -0.9748766 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: -1.028001 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: -0.9970024 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: -0.9829232 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: -1.010065 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: -1.033674 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: -0.955516 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: -0.955918 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: -1.017967 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: -1.064915 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: -1.051617 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: -1.010095 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: -1.020355 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: -1.07867 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: -1.101065 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: -1.096055 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: -1.080282 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: -1.076922 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: -1.086451 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: -1.104427 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: -1.097268 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: -1.085059 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: -1.098109 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: -1.122119 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: -1.138339 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: -1.143626 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: -1.147644 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: -1.154289 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: -1.161386 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: -1.161205 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: -1.156954 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: -1.15769 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: -1.164923 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: -1.168745 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: -1.171132 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: -1.175271 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: -1.1787 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: -1.181046 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: -1.181928 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: -1.182939 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: -1.185814 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: -1.189247 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: -1.196132 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: -1.200734 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: -1.204275 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: -1.20641 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: -1.212019 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: -1.213367 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: -1.212863 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: -1.215509 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: -1.213366 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: -1.214144 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: -1.214481 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: -1.218848 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: -1.223038 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: -1.228873 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: -1.232212 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: -1.230932 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: -1.227582 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: -1.230078 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: -1.230571 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: -1.233432 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: -1.235708 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: -1.23992 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: -1.245862 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: -1.249712 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: -1.253448 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: -1.257686 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: -1.254147 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: -1.259764 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: -1.255009 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: -1.249259 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: -1.246171 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: -1.250303 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: -1.250268 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: -1.254118 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: -1.251869 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: -1.256794 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: -1.245189 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: -1.252028 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: -1.236506 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: -1.197249 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: -1.12555 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: -1.225529 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: -1.239903 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: -1.171408 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: -1.216051 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: -1.255342 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: -1.239687 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: -1.233069 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: -1.25306 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: -1.248689 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: -1.217857 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: -1.243745 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: -1.261393 </span></span>
<span><span class="co">#&gt; = Starting epoch 129 </span></span>
<span><span class="co">#&gt; Test loss: -1.250684 </span></span>
<span><span class="co">#&gt; = Starting epoch 130 </span></span>
<span><span class="co">#&gt; Test loss: -1.24986 </span></span>
<span><span class="co">#&gt; = Starting epoch 131 </span></span>
<span><span class="co">#&gt; Test loss: -1.264205 </span></span>
<span><span class="co">#&gt; = Starting epoch 132 </span></span>
<span><span class="co">#&gt; Test loss: -1.274845 </span></span>
<span><span class="co">#&gt; = Starting epoch 133 </span></span>
<span><span class="co">#&gt; Test loss: -1.256502 </span></span>
<span><span class="co">#&gt; = Starting epoch 134 </span></span>
<span><span class="co">#&gt; Test loss: -1.262275 </span></span>
<span><span class="co">#&gt; = Starting epoch 135 </span></span>
<span><span class="co">#&gt; Test loss: -1.277822 </span></span>
<span><span class="co">#&gt; = Starting epoch 136 </span></span>
<span><span class="co">#&gt; Test loss: -1.273979 </span></span>
<span><span class="co">#&gt; = Starting epoch 137 </span></span>
<span><span class="co">#&gt; Test loss: -1.266305 </span></span>
<span><span class="co">#&gt; = Starting epoch 138 </span></span>
<span><span class="co">#&gt; Test loss: -1.275749 </span></span>
<span><span class="co">#&gt; = Starting epoch 139 </span></span>
<span><span class="co">#&gt; Test loss: -1.269063 </span></span>
<span><span class="co">#&gt; = Starting epoch 140 </span></span>
<span><span class="co">#&gt; Test loss: -1.252776 </span></span>
<span><span class="co">#&gt; = Starting epoch 141 </span></span>
<span><span class="co">#&gt; Test loss: -1.26968 </span></span>
<span><span class="co">#&gt; = Starting epoch 142 </span></span>
<span><span class="co">#&gt; Test loss: -1.288304 </span></span>
<span><span class="co">#&gt; = Starting epoch 143 </span></span>
<span><span class="co">#&gt; Test loss: -1.279927 </span></span>
<span><span class="co">#&gt; = Starting epoch 144 </span></span>
<span><span class="co">#&gt; Test loss: -1.274439 </span></span>
<span><span class="co">#&gt; = Starting epoch 145 </span></span>
<span><span class="co">#&gt; Test loss: -1.285695 </span></span>
<span><span class="co">#&gt; = Starting epoch 146 </span></span>
<span><span class="co">#&gt; Test loss: -1.285016 </span></span>
<span><span class="co">#&gt; = Starting epoch 147 </span></span>
<span><span class="co">#&gt; Test loss: -1.276151 </span></span>
<span><span class="co">#&gt; = Starting epoch 148 </span></span>
<span><span class="co">#&gt; Test loss: -1.281793 </span></span>
<span><span class="co">#&gt; = Starting epoch 149 </span></span>
<span><span class="co">#&gt; Test loss: -1.283499 </span></span>
<span><span class="co">#&gt; = Starting epoch 150 </span></span>
<span><span class="co">#&gt; Test loss: -1.279271 </span></span>
<span><span class="co">#&gt; = Starting epoch 151 </span></span>
<span><span class="co">#&gt; Test loss: -1.281792 </span></span>
<span><span class="co">#&gt; = Starting epoch 152 </span></span>
<span><span class="co">#&gt; Test loss: -1.283179 </span></span>
<span><span class="co">#&gt; = Starting epoch 153 </span></span>
<span><span class="co">#&gt; Test loss: -1.282143 </span></span>
<span><span class="co">#&gt; = Starting epoch 154 </span></span>
<span><span class="co">#&gt; Test loss: -1.277469 </span></span>
<span><span class="co">#&gt; = Starting epoch 155 </span></span>
<span><span class="co">#&gt; Test loss: -1.277132 </span></span>
<span><span class="co">#&gt; = Starting epoch 156 </span></span>
<span><span class="co">#&gt; Test loss: -1.285185 </span></span>
<span><span class="co">#&gt; = Starting epoch 157 </span></span>
<span><span class="co">#&gt; Test loss: -1.285993 </span></span>
<span><span class="co">#&gt; = Starting epoch 158 </span></span>
<span><span class="co">#&gt; Test loss: -1.287177 </span></span>
<span><span class="co">#&gt; = Starting epoch 159 </span></span>
<span><span class="co">#&gt; Test loss: -1.28901 </span></span>
<span><span class="co">#&gt; = Starting epoch 160 </span></span>
<span><span class="co">#&gt; Test loss: -1.288399 </span></span>
<span><span class="co">#&gt; = Starting epoch 161 </span></span>
<span><span class="co">#&gt; Test loss: -1.294372 </span></span>
<span><span class="co">#&gt; = Starting epoch 162 </span></span>
<span><span class="co">#&gt; Test loss: -1.298282 </span></span>
<span><span class="co">#&gt; = Starting epoch 163 </span></span>
<span><span class="co">#&gt; Test loss: -1.295361 </span></span>
<span><span class="co">#&gt; = Starting epoch 164 </span></span>
<span><span class="co">#&gt; Test loss: -1.295321 </span></span>
<span><span class="co">#&gt; = Starting epoch 165 </span></span>
<span><span class="co">#&gt; Test loss: -1.297859 </span></span>
<span><span class="co">#&gt; = Starting epoch 166 </span></span>
<span><span class="co">#&gt; Test loss: -1.29966 </span></span>
<span><span class="co">#&gt; = Starting epoch 167 </span></span>
<span><span class="co">#&gt; Test loss: -1.290149 </span></span>
<span><span class="co">#&gt; = Starting epoch 168 </span></span>
<span><span class="co">#&gt; Test loss: -1.283029 </span></span>
<span><span class="co">#&gt; = Starting epoch 169 </span></span>
<span><span class="co">#&gt; Test loss: -1.298553 </span></span>
<span><span class="co">#&gt; = Starting epoch 170 </span></span>
<span><span class="co">#&gt; Test loss: -1.304471 </span></span>
<span><span class="co">#&gt; = Starting epoch 171 </span></span>
<span><span class="co">#&gt; Test loss: -1.302801 </span></span>
<span><span class="co">#&gt; = Starting epoch 172 </span></span>
<span><span class="co">#&gt; Test loss: -1.303421 </span></span>
<span><span class="co">#&gt; = Starting epoch 173 </span></span>
<span><span class="co">#&gt; Test loss: -1.309422 </span></span>
<span><span class="co">#&gt; = Starting epoch 174 </span></span>
<span><span class="co">#&gt; Test loss: -1.310073 </span></span>
<span><span class="co">#&gt; = Starting epoch 175 </span></span>
<span><span class="co">#&gt; Test loss: -1.300674 </span></span>
<span><span class="co">#&gt; = Starting epoch 176 </span></span>
<span><span class="co">#&gt; Test loss: -1.295162 </span></span>
<span><span class="co">#&gt; = Starting epoch 177 </span></span>
<span><span class="co">#&gt; Test loss: -1.296533 </span></span>
<span><span class="co">#&gt; = Starting epoch 178 </span></span>
<span><span class="co">#&gt; Test loss: -1.304499 </span></span>
<span><span class="co">#&gt; = Starting epoch 179 </span></span>
<span><span class="co">#&gt; Test loss: -1.307945 </span></span>
<span><span class="co">#&gt; = Starting epoch 180 </span></span>
<span><span class="co">#&gt; Test loss: -1.30933 </span></span>
<span><span class="co">#&gt; = Starting epoch 181 </span></span>
<span><span class="co">#&gt; Test loss: -1.31092 </span></span>
<span><span class="co">#&gt; = Starting epoch 182 </span></span>
<span><span class="co">#&gt; Test loss: -1.315053 </span></span>
<span><span class="co">#&gt; = Starting epoch 183 </span></span>
<span><span class="co">#&gt; Test loss: -1.318443 </span></span>
<span><span class="co">#&gt; = Starting epoch 184 </span></span>
<span><span class="co">#&gt; Test loss: -1.313586 </span></span>
<span><span class="co">#&gt; = Starting epoch 185 </span></span>
<span><span class="co">#&gt; Test loss: -1.310577 </span></span>
<span><span class="co">#&gt; = Starting epoch 186 </span></span>
<span><span class="co">#&gt; Test loss: -1.310701 </span></span>
<span><span class="co">#&gt; = Starting epoch 187 </span></span>
<span><span class="co">#&gt; Test loss: -1.315295 </span></span>
<span><span class="co">#&gt; = Starting epoch 188 </span></span>
<span><span class="co">#&gt; Test loss: -1.314178 </span></span>
<span><span class="co">#&gt; = Starting epoch 189 </span></span>
<span><span class="co">#&gt; Test loss: -1.311511 </span></span>
<span><span class="co">#&gt; = Starting epoch 190 </span></span>
<span><span class="co">#&gt; Test loss: -1.298755 </span></span>
<span><span class="co">#&gt; = Starting epoch 191 </span></span>
<span><span class="co">#&gt; Test loss: -1.29226 </span></span>
<span><span class="co">#&gt; = Starting epoch 192 </span></span>
<span><span class="co">#&gt; Test loss: -1.302821 </span></span>
<span><span class="co">#&gt; = Starting epoch 193 </span></span>
<span><span class="co">#&gt; Test loss: -1.303037 </span></span>
<span><span class="co">#&gt; = Starting epoch 194 </span></span>
<span><span class="co">#&gt; Test loss: -1.315663 </span></span>
<span><span class="co">#&gt; = Starting epoch 195 </span></span>
<span><span class="co">#&gt; Test loss: -1.308196 </span></span>
<span><span class="co">#&gt; = Starting epoch 196 </span></span>
<span><span class="co">#&gt; Test loss: -1.319869 </span></span>
<span><span class="co">#&gt; = Starting epoch 197 </span></span>
<span><span class="co">#&gt; Test loss: -1.317494 </span></span>
<span><span class="co">#&gt; = Starting epoch 198 </span></span>
<span><span class="co">#&gt; Test loss: -1.311539 </span></span>
<span><span class="co">#&gt; = Starting epoch 199 </span></span>
<span><span class="co">#&gt; Test loss: -1.308777 </span></span>
<span><span class="co">#&gt; = Starting epoch 200 </span></span>
<span><span class="co">#&gt; Test loss: -1.304482 </span></span>
<span><span class="co">#&gt; = Starting epoch 201 </span></span>
<span><span class="co">#&gt; Test loss: -1.308251 </span></span>
<span><span class="co">#&gt; = Starting epoch 202 </span></span>
<span><span class="co">#&gt; Test loss: -1.314206 </span></span>
<span><span class="co">#&gt; = Starting epoch 203 </span></span>
<span><span class="co">#&gt; Test loss: -1.319358 </span></span>
<span><span class="co">#&gt; = Starting epoch 204 </span></span>
<span><span class="co">#&gt; Test loss: -1.322493 </span></span>
<span><span class="co">#&gt; = Starting epoch 205 </span></span>
<span><span class="co">#&gt; Test loss: -1.320667 </span></span>
<span><span class="co">#&gt; = Starting epoch 206 </span></span>
<span><span class="co">#&gt; Test loss: -1.316056 </span></span>
<span><span class="co">#&gt; = Starting epoch 207 </span></span>
<span><span class="co">#&gt; Test loss: -1.314879 </span></span>
<span><span class="co">#&gt; = Starting epoch 208 </span></span>
<span><span class="co">#&gt; Test loss: -1.318794 </span></span>
<span><span class="co">#&gt; = Starting epoch 209 </span></span>
<span><span class="co">#&gt; Test loss: -1.317554 </span></span>
<span><span class="co">#&gt; = Starting epoch 210 </span></span>
<span><span class="co">#&gt; Test loss: -1.316724 </span></span>
<span><span class="co">#&gt; = Starting epoch 211 </span></span>
<span><span class="co">#&gt; Test loss: -1.318212 </span></span>
<span><span class="co">#&gt; = Starting epoch 212 </span></span>
<span><span class="co">#&gt; Test loss: -1.31833 </span></span>
<span><span class="co">#&gt; = Starting epoch 213 </span></span>
<span><span class="co">#&gt; Test loss: -1.31895 </span></span>
<span><span class="co">#&gt; = Starting epoch 214 </span></span>
<span><span class="co">#&gt; Test loss: -1.322312 </span></span>
<span><span class="co">#&gt; = Starting epoch 215 </span></span>
<span><span class="co">#&gt; Test loss: -1.322696 </span></span>
<span><span class="co">#&gt; = Starting epoch 216 </span></span>
<span><span class="co">#&gt; Test loss: -1.324024 </span></span>
<span><span class="co">#&gt; = Starting epoch 217 </span></span>
<span><span class="co">#&gt; Test loss: -1.327857 </span></span>
<span><span class="co">#&gt; = Starting epoch 218 </span></span>
<span><span class="co">#&gt; Test loss: -1.323195 </span></span>
<span><span class="co">#&gt; = Starting epoch 219 </span></span>
<span><span class="co">#&gt; Test loss: -1.312618 </span></span>
<span><span class="co">#&gt; = Starting epoch 220 </span></span>
<span><span class="co">#&gt; Test loss: -1.310482 </span></span>
<span><span class="co">#&gt; = Starting epoch 221 </span></span>
<span><span class="co">#&gt; Test loss: -1.305729 </span></span>
<span><span class="co">#&gt; = Starting epoch 222 </span></span>
<span><span class="co">#&gt; Test loss: -1.31438 </span></span>
<span><span class="co">#&gt; = Starting epoch 223 </span></span>
<span><span class="co">#&gt; Test loss: -1.315829 </span></span>
<span><span class="co">#&gt; = Starting epoch 224 </span></span>
<span><span class="co">#&gt; Test loss: -1.325269 </span></span>
<span><span class="co">#&gt; = Starting epoch 225 </span></span>
<span><span class="co">#&gt; Test loss: -1.312111 </span></span>
<span><span class="co">#&gt; = Starting epoch 226 </span></span>
<span><span class="co">#&gt; Test loss: -1.32181 </span></span>
<span><span class="co">#&gt; = Starting epoch 227 </span></span>
<span><span class="co">#&gt; Test loss: -1.306396 </span></span>
<span><span class="co">#&gt; = Starting epoch 228 </span></span>
<span><span class="co">#&gt; Test loss: -1.323511 </span></span>
<span><span class="co">#&gt; = Starting epoch 229 </span></span>
<span><span class="co">#&gt; Test loss: -1.31611 </span></span>
<span><span class="co">#&gt; = Starting epoch 230 </span></span>
<span><span class="co">#&gt; Test loss: -1.329225 </span></span>
<span><span class="co">#&gt; = Starting epoch 231 </span></span>
<span><span class="co">#&gt; Test loss: -1.311278 </span></span>
<span><span class="co">#&gt; = Starting epoch 232 </span></span>
<span><span class="co">#&gt; Test loss: -1.330481 </span></span>
<span><span class="co">#&gt; = Starting epoch 233 </span></span>
<span><span class="co">#&gt; Test loss: -1.29669 </span></span>
<span><span class="co">#&gt; = Starting epoch 234 </span></span>
<span><span class="co">#&gt; Test loss: -1.310024 </span></span>
<span><span class="co">#&gt; = Starting epoch 235 </span></span>
<span><span class="co">#&gt; Test loss: -1.274523 </span></span>
<span><span class="co">#&gt; = Starting epoch 236 </span></span>
<span><span class="co">#&gt; Test loss: -1.305645 </span></span>
<span><span class="co">#&gt; = Starting epoch 237 </span></span>
<span><span class="co">#&gt; Test loss: -1.310456 </span></span>
<span><span class="co">#&gt; = Starting epoch 238 </span></span>
<span><span class="co">#&gt; Test loss: -1.280634 </span></span>
<span><span class="co">#&gt; = Starting epoch 239 </span></span>
<span><span class="co">#&gt; Test loss: -1.29675 </span></span>
<span><span class="co">#&gt; = Starting epoch 240 </span></span>
<span><span class="co">#&gt; Test loss: -1.295612 </span></span>
<span><span class="co">#&gt; = Starting epoch 241 </span></span>
<span><span class="co">#&gt; Test loss: -1.30206 </span></span>
<span><span class="co">#&gt; = Starting epoch 242 </span></span>
<span><span class="co">#&gt; Test loss: -1.322596 </span></span>
<span><span class="co">#&gt; = Starting epoch 243 </span></span>
<span><span class="co">#&gt; Test loss: -1.313794 </span></span>
<span><span class="co">#&gt; = Starting epoch 244 </span></span>
<span><span class="co">#&gt; Test loss: -1.298467 </span></span>
<span><span class="co">#&gt; = Starting epoch 245 </span></span>
<span><span class="co">#&gt; Test loss: -1.310218 </span></span>
<span><span class="co">#&gt; = Starting epoch 246 </span></span>
<span><span class="co">#&gt; Test loss: -1.318484 </span></span>
<span><span class="co">#&gt; = Starting epoch 247 </span></span>
<span><span class="co">#&gt; Test loss: -1.294706 </span></span>
<span><span class="co">#&gt; = Starting epoch 248 </span></span>
<span><span class="co">#&gt; Test loss: -1.300262 </span></span>
<span><span class="co">#&gt; = Starting epoch 249 </span></span>
<span><span class="co">#&gt; Test loss: -1.320329 </span></span>
<span><span class="co">#&gt; = Starting epoch 250 </span></span>
<span><span class="co">#&gt; Test loss: -1.309616 </span></span>
<span><span class="co">#&gt; = Starting epoch 251 </span></span>
<span><span class="co">#&gt; Test loss: -1.304691 </span></span>
<span><span class="co">#&gt; = Starting epoch 252 </span></span>
<span><span class="co">#&gt; Test loss: -1.326932 </span></span>
<span><span class="co">#&gt; = Starting epoch 253 </span></span>
<span><span class="co">#&gt; Test loss: -1.320045 </span></span>
<span><span class="co">#&gt; = Starting epoch 254 </span></span>
<span><span class="co">#&gt; Test loss: -1.313537 </span></span>
<span><span class="co">#&gt; = Starting epoch 255 </span></span>
<span><span class="co">#&gt; Test loss: -1.308624 </span></span>
<span><span class="co">#&gt; = Starting epoch 256 </span></span>
<span><span class="co">#&gt; Test loss: -1.298502</span></span></code></pre></div>
<p>We can generate samples from the trained flow as follows, where now
the samples are conditioned on the values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate 1024 samples for each of the first 4 conditioning variables in the test set</span></span>
<span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">flow_model</span>, <span class="fl">1024</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'log(sigma)'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
<p>We can also plot the samples on a scatter plot:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">'mu'</span>, ylab <span class="op">=</span> <span class="st">'log(sigma)'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">8</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-14-1.png" width="768"></p>
<p><strong>Compare these to MCMC</strong></p>
</div>
<div class="section level2">
<h2 id="using-a-summarizing-network">Using a summarizing network<a class="anchor" aria-label="anchor" href="#using-a-summarizing-network"></a>
</h2>
<p>In the above example, the conditioning variable <code>y</code>
contains four replicates of the conditioning variable. We ignored the
fact that these are replicates, and the trained the flow as though they
could be dependent. We can instead use a summarizing network that
individually processes each individual replicate into a set of summary
statistics, and then combine the summary statistics in a permutation
invariant way to form the conditioning variable. Here is an example
summarizing network:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Helper modules</span></span>
<span><span class="va">nn_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dimension</span> <span class="op">&lt;-</span> <span class="va">dimension</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_sum.html" class="external-link">torch_sum</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">self</span><span class="op">$</span><span class="va">dimension</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nn_unsqueeze</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dimension</span> <span class="op">&lt;-</span> <span class="va">dimension</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">self</span><span class="op">$</span><span class="va">dimension</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="co"># Add an extra unit dimension for the replicate dimension</span></span>
<span>  <span class="fu">nn_unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="co"># Compute the summary statistics for each replicate</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="co"># Sum the summary statistics across the replicates</span></span>
<span>  <span class="fu">nn_sum</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">summary_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">10</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; -0.0531  0.2401  0.4739  0.0802 -0.5223  0.9025  0.8651  0.1151</span></span>
<span><span class="co">#&gt;  0.0145  0.1609  0.3921 -0.1430 -0.6711  0.3215  0.2935  0.5131</span></span>
<span><span class="co">#&gt;  0.0278  0.0246  0.2963 -0.1513 -0.6662  0.3833  0.3838  0.5540</span></span>
<span><span class="co">#&gt;  0.0260  0.0295  0.3201 -0.0826 -0.6089  0.6004  0.5799  0.4391</span></span>
<span><span class="co">#&gt; -0.2345  0.4038  0.4497 -0.3624 -0.8951 -0.6016 -0.4141  0.8465</span></span>
<span><span class="co">#&gt; -0.2871  0.4911  0.6473  0.0710 -0.4198  1.3093  1.2130 -0.3116</span></span>
<span><span class="co">#&gt;  0.0221 -0.0552  0.2397 -0.1613 -0.6450  0.4456  0.4205  0.5885</span></span>
<span><span class="co">#&gt;  0.0370  0.0591  0.3643 -0.0432 -0.5872  0.6650  0.6557  0.3695</span></span>
<span><span class="co">#&gt;  0.0268  0.0890  0.3866 -0.0274 -0.5695  0.6955  0.6815  0.3302</span></span>
<span><span class="co">#&gt;  0.0089  0.1139  0.3984 -0.0147 -0.5639  0.7176  0.6865  0.3062</span></span>
<span><span class="co">#&gt; [ CPUFloatType{10,8} ][ grad_fn = &lt;SumBackward1&gt; ]</span></span></code></pre></div>
<p>We can combine the summarizing network with the flow in a
<code>nn_summarizing_conditional_flow</code> object:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">summarizing_flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_summarizing_conditional_flow.html">nn_summarizing_conditional_flow</a></span><span class="op">(</span><span class="va">summary_model</span>, <span class="va">flow_model</span><span class="op">)</span></span></code></pre></div>
<p>Let’s also expand the number of replicated observations to 32:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_conditional_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span> <span class="op">*</span> <span class="va">sigma</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">sigma</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mu</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_log.html" class="external-link">torch_log</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    conditioning <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s train the model:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_conditional_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ target      :Float [1:1024, 1:2]</span></span>
<span><span class="co">#&gt;  $ conditioning:Float [1:1024, 1:32]</span></span>
<span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">summarizing_flow_model</span>,</span>
<span>  <span class="va">generate_conditional_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">256</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">summarizing_flow_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 2.091604 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 1.348904 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: 1.456296 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: 1.191717 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: 0.7356679 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: 0.217484 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: -0.3002083 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: -0.7264695 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: -0.9651535 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: -1.09569 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: -1.239189 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: -1.271928 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: -1.23335 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: -1.314218 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: -1.578394 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -1.761702 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -1.739383 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -1.679132 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -1.701024 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -1.73458 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -1.829803 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -1.929062 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -2.001361 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -2.011087 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -2.024673 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -2.053892 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -2.120488 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -2.188325 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -2.190778 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -2.260599 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -2.267946 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -2.28395 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: -2.386481 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: -2.366489 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: -2.436373 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: -2.463618 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: -2.506962 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: -2.551173 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: -2.5786 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: -2.609433 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: -2.646513 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: -2.682989 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: -2.704848 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: -2.733719 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: -2.726454 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: -2.766953 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: -2.7563 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: -2.812119 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: -2.82656 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: -2.822115 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: -2.869969 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: -2.87584 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: -2.888814 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: -2.922591 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: -2.906233 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: -2.920973 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: -2.935676 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: -2.951282 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: -2.960169 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: -2.963227 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: -2.975478 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: -2.982824 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: -2.980164 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: -2.979243 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: -2.920592 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: -3.009168 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: -2.938455 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: -2.966595 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: -3.004086 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: -3.012246 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: -3.044666 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: -3.008252 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: -3.059506 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: -3.011902 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: -2.993879 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: -2.92097 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: -3.027468 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: -3.042383 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: -3.024028 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: -3.074146 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: -3.001352 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: -3.053642 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: -3.062064 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: -3.055535 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: -3.001879 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: -3.019824 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: -3.065059 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: -3.020987 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: -3.036799 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: -3.037548 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: -3.024361 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: -3.089344 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: -2.965918 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: -3.086867 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: -3.024787 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: -3.073772 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: -3.059098 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: -3.101059 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: -3.068803 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: -3.083215 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: -3.100997 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: -3.062814 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: -3.09021 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: -3.117868 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: -3.07653 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: -3.009357 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: -3.111087 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: -3.056229 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: -3.004982 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: -3.035919 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: -3.100226 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: -3.071848 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: -3.126217 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: -3.088851 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: -3.123314 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: -3.14299 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: -3.094511 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: -3.131832 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: -3.159106 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: -3.158473 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: -3.145449 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: -3.157113 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: -3.152523 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: -3.165358 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: -3.161681 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: -3.173456 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: -3.167512 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: -3.171601 </span></span>
<span><span class="co">#&gt; = Starting epoch 129 </span></span>
<span><span class="co">#&gt; Test loss: -3.158097 </span></span>
<span><span class="co">#&gt; = Starting epoch 130 </span></span>
<span><span class="co">#&gt; Test loss: -3.097694 </span></span>
<span><span class="co">#&gt; = Starting epoch 131 </span></span>
<span><span class="co">#&gt; Test loss: -3.149673 </span></span>
<span><span class="co">#&gt; = Starting epoch 132 </span></span>
<span><span class="co">#&gt; Test loss: -3.167446 </span></span>
<span><span class="co">#&gt; = Starting epoch 133 </span></span>
<span><span class="co">#&gt; Test loss: -3.120349 </span></span>
<span><span class="co">#&gt; = Starting epoch 134 </span></span>
<span><span class="co">#&gt; Test loss: -3.161375 </span></span>
<span><span class="co">#&gt; = Starting epoch 135 </span></span>
<span><span class="co">#&gt; Test loss: -3.139135 </span></span>
<span><span class="co">#&gt; = Starting epoch 136 </span></span>
<span><span class="co">#&gt; Test loss: -3.100416 </span></span>
<span><span class="co">#&gt; = Starting epoch 137 </span></span>
<span><span class="co">#&gt; Test loss: -3.166062 </span></span>
<span><span class="co">#&gt; = Starting epoch 138 </span></span>
<span><span class="co">#&gt; Test loss: -3.133667 </span></span>
<span><span class="co">#&gt; = Starting epoch 139 </span></span>
<span><span class="co">#&gt; Test loss: -3.150239 </span></span>
<span><span class="co">#&gt; = Starting epoch 140 </span></span>
<span><span class="co">#&gt; Test loss: -3.172149 </span></span>
<span><span class="co">#&gt; = Starting epoch 141 </span></span>
<span><span class="co">#&gt; Test loss: -3.057402 </span></span>
<span><span class="co">#&gt; = Starting epoch 142 </span></span>
<span><span class="co">#&gt; Test loss: -3.112572 </span></span>
<span><span class="co">#&gt; = Starting epoch 143 </span></span>
<span><span class="co">#&gt; Test loss: -3.171893 </span></span>
<span><span class="co">#&gt; = Starting epoch 144 </span></span>
<span><span class="co">#&gt; Test loss: -3.055429 </span></span>
<span><span class="co">#&gt; = Starting epoch 145 </span></span>
<span><span class="co">#&gt; Test loss: -3.162233 </span></span>
<span><span class="co">#&gt; = Starting epoch 146 </span></span>
<span><span class="co">#&gt; Test loss: -3.096728 </span></span>
<span><span class="co">#&gt; = Starting epoch 147 </span></span>
<span><span class="co">#&gt; Test loss: -3.100924 </span></span>
<span><span class="co">#&gt; = Starting epoch 148 </span></span>
<span><span class="co">#&gt; Test loss: -3.152704 </span></span>
<span><span class="co">#&gt; = Starting epoch 149 </span></span>
<span><span class="co">#&gt; Test loss: -3.088395 </span></span>
<span><span class="co">#&gt; = Starting epoch 150 </span></span>
<span><span class="co">#&gt; Test loss: -3.13808 </span></span>
<span><span class="co">#&gt; = Starting epoch 151 </span></span>
<span><span class="co">#&gt; Test loss: -3.185732 </span></span>
<span><span class="co">#&gt; = Starting epoch 152 </span></span>
<span><span class="co">#&gt; Test loss: -3.102695 </span></span>
<span><span class="co">#&gt; = Starting epoch 153 </span></span>
<span><span class="co">#&gt; Test loss: -3.195957 </span></span>
<span><span class="co">#&gt; = Starting epoch 154 </span></span>
<span><span class="co">#&gt; Test loss: -3.080887 </span></span>
<span><span class="co">#&gt; = Starting epoch 155 </span></span>
<span><span class="co">#&gt; Test loss: -3.106808 </span></span>
<span><span class="co">#&gt; = Starting epoch 156 </span></span>
<span><span class="co">#&gt; Test loss: -3.167853 </span></span>
<span><span class="co">#&gt; = Starting epoch 157 </span></span>
<span><span class="co">#&gt; Test loss: -3.13397 </span></span>
<span><span class="co">#&gt; = Starting epoch 158 </span></span>
<span><span class="co">#&gt; Test loss: -3.113267 </span></span>
<span><span class="co">#&gt; = Starting epoch 159 </span></span>
<span><span class="co">#&gt; Test loss: -3.192416 </span></span>
<span><span class="co">#&gt; = Starting epoch 160 </span></span>
<span><span class="co">#&gt; Test loss: -3.09777 </span></span>
<span><span class="co">#&gt; = Starting epoch 161 </span></span>
<span><span class="co">#&gt; Test loss: -3.198964 </span></span>
<span><span class="co">#&gt; = Starting epoch 162 </span></span>
<span><span class="co">#&gt; Test loss: -3.168457 </span></span>
<span><span class="co">#&gt; = Starting epoch 163 </span></span>
<span><span class="co">#&gt; Test loss: -3.149436 </span></span>
<span><span class="co">#&gt; = Starting epoch 164 </span></span>
<span><span class="co">#&gt; Test loss: -3.190754 </span></span>
<span><span class="co">#&gt; = Starting epoch 165 </span></span>
<span><span class="co">#&gt; Test loss: -3.17038 </span></span>
<span><span class="co">#&gt; = Starting epoch 166 </span></span>
<span><span class="co">#&gt; Test loss: -3.189268 </span></span>
<span><span class="co">#&gt; = Starting epoch 167 </span></span>
<span><span class="co">#&gt; Test loss: -3.19417 </span></span>
<span><span class="co">#&gt; = Starting epoch 168 </span></span>
<span><span class="co">#&gt; Test loss: -3.185724 </span></span>
<span><span class="co">#&gt; = Starting epoch 169 </span></span>
<span><span class="co">#&gt; Test loss: -3.179356 </span></span>
<span><span class="co">#&gt; = Starting epoch 170 </span></span>
<span><span class="co">#&gt; Test loss: -3.184073 </span></span>
<span><span class="co">#&gt; = Starting epoch 171 </span></span>
<span><span class="co">#&gt; Test loss: -3.19913 </span></span>
<span><span class="co">#&gt; = Starting epoch 172 </span></span>
<span><span class="co">#&gt; Test loss: -3.189997 </span></span>
<span><span class="co">#&gt; = Starting epoch 173 </span></span>
<span><span class="co">#&gt; Test loss: -3.225701 </span></span>
<span><span class="co">#&gt; = Starting epoch 174 </span></span>
<span><span class="co">#&gt; Test loss: -3.201677 </span></span>
<span><span class="co">#&gt; = Starting epoch 175 </span></span>
<span><span class="co">#&gt; Test loss: -3.219449 </span></span>
<span><span class="co">#&gt; = Starting epoch 176 </span></span>
<span><span class="co">#&gt; Test loss: -3.222347 </span></span>
<span><span class="co">#&gt; = Starting epoch 177 </span></span>
<span><span class="co">#&gt; Test loss: -3.216145 </span></span>
<span><span class="co">#&gt; = Starting epoch 178 </span></span>
<span><span class="co">#&gt; Test loss: -3.20999 </span></span>
<span><span class="co">#&gt; = Starting epoch 179 </span></span>
<span><span class="co">#&gt; Test loss: -3.220918 </span></span>
<span><span class="co">#&gt; = Starting epoch 180 </span></span>
<span><span class="co">#&gt; Test loss: -3.146715 </span></span>
<span><span class="co">#&gt; = Starting epoch 181 </span></span>
<span><span class="co">#&gt; Test loss: -3.179759 </span></span>
<span><span class="co">#&gt; = Starting epoch 182 </span></span>
<span><span class="co">#&gt; Test loss: -3.214022 </span></span>
<span><span class="co">#&gt; = Starting epoch 183 </span></span>
<span><span class="co">#&gt; Test loss: -3.217731 </span></span>
<span><span class="co">#&gt; = Starting epoch 184 </span></span>
<span><span class="co">#&gt; Test loss: -3.212584 </span></span>
<span><span class="co">#&gt; = Starting epoch 185 </span></span>
<span><span class="co">#&gt; Test loss: -3.183554 </span></span>
<span><span class="co">#&gt; = Starting epoch 186 </span></span>
<span><span class="co">#&gt; Test loss: -3.210176 </span></span>
<span><span class="co">#&gt; = Starting epoch 187 </span></span>
<span><span class="co">#&gt; Test loss: -3.189465 </span></span>
<span><span class="co">#&gt; = Starting epoch 188 </span></span>
<span><span class="co">#&gt; Test loss: -3.194413 </span></span>
<span><span class="co">#&gt; = Starting epoch 189 </span></span>
<span><span class="co">#&gt; Test loss: -3.132815 </span></span>
<span><span class="co">#&gt; = Starting epoch 190 </span></span>
<span><span class="co">#&gt; Test loss: -3.206819 </span></span>
<span><span class="co">#&gt; = Starting epoch 191 </span></span>
<span><span class="co">#&gt; Test loss: -3.222301 </span></span>
<span><span class="co">#&gt; = Starting epoch 192 </span></span>
<span><span class="co">#&gt; Test loss: -3.195821 </span></span>
<span><span class="co">#&gt; = Starting epoch 193 </span></span>
<span><span class="co">#&gt; Test loss: -3.220118 </span></span>
<span><span class="co">#&gt; = Starting epoch 194 </span></span>
<span><span class="co">#&gt; Test loss: -3.199736 </span></span>
<span><span class="co">#&gt; = Starting epoch 195 </span></span>
<span><span class="co">#&gt; Test loss: -3.177719 </span></span>
<span><span class="co">#&gt; = Starting epoch 196 </span></span>
<span><span class="co">#&gt; Test loss: -3.171977 </span></span>
<span><span class="co">#&gt; = Starting epoch 197 </span></span>
<span><span class="co">#&gt; Test loss: -3.21618 </span></span>
<span><span class="co">#&gt; = Starting epoch 198 </span></span>
<span><span class="co">#&gt; Test loss: -3.14232 </span></span>
<span><span class="co">#&gt; = Starting epoch 199 </span></span>
<span><span class="co">#&gt; Test loss: -3.16825 </span></span>
<span><span class="co">#&gt; = Starting epoch 200 </span></span>
<span><span class="co">#&gt; Test loss: -3.201704 </span></span>
<span><span class="co">#&gt; = Starting epoch 201 </span></span>
<span><span class="co">#&gt; Test loss: -3.017632 </span></span>
<span><span class="co">#&gt; = Starting epoch 202 </span></span>
<span><span class="co">#&gt; Test loss: -3.085507 </span></span>
<span><span class="co">#&gt; = Starting epoch 203 </span></span>
<span><span class="co">#&gt; Test loss: -3.209049 </span></span>
<span><span class="co">#&gt; = Starting epoch 204 </span></span>
<span><span class="co">#&gt; Test loss: -2.944839 </span></span>
<span><span class="co">#&gt; = Starting epoch 205 </span></span>
<span><span class="co">#&gt; Test loss: -3.048542 </span></span>
<span><span class="co">#&gt; = Starting epoch 206 </span></span>
<span><span class="co">#&gt; Test loss: -3.119879 </span></span>
<span><span class="co">#&gt; = Starting epoch 207 </span></span>
<span><span class="co">#&gt; Test loss: -2.959311 </span></span>
<span><span class="co">#&gt; = Starting epoch 208 </span></span>
<span><span class="co">#&gt; Test loss: -3.175924 </span></span>
<span><span class="co">#&gt; = Starting epoch 209 </span></span>
<span><span class="co">#&gt; Test loss: -3.095038 </span></span>
<span><span class="co">#&gt; = Starting epoch 210 </span></span>
<span><span class="co">#&gt; Test loss: -3.118827 </span></span>
<span><span class="co">#&gt; = Starting epoch 211 </span></span>
<span><span class="co">#&gt; Test loss: -3.171568 </span></span>
<span><span class="co">#&gt; = Starting epoch 212 </span></span>
<span><span class="co">#&gt; Test loss: -3.153835 </span></span>
<span><span class="co">#&gt; = Starting epoch 213 </span></span>
<span><span class="co">#&gt; Test loss: -3.177964 </span></span>
<span><span class="co">#&gt; = Starting epoch 214 </span></span>
<span><span class="co">#&gt; Test loss: -3.121989 </span></span>
<span><span class="co">#&gt; = Starting epoch 215 </span></span>
<span><span class="co">#&gt; Test loss: -3.229798 </span></span>
<span><span class="co">#&gt; = Starting epoch 216 </span></span>
<span><span class="co">#&gt; Test loss: -3.172442 </span></span>
<span><span class="co">#&gt; = Starting epoch 217 </span></span>
<span><span class="co">#&gt; Test loss: -3.187002 </span></span>
<span><span class="co">#&gt; = Starting epoch 218 </span></span>
<span><span class="co">#&gt; Test loss: -3.175196 </span></span>
<span><span class="co">#&gt; = Starting epoch 219 </span></span>
<span><span class="co">#&gt; Test loss: -3.194678 </span></span>
<span><span class="co">#&gt; = Starting epoch 220 </span></span>
<span><span class="co">#&gt; Test loss: -3.178824 </span></span>
<span><span class="co">#&gt; = Starting epoch 221 </span></span>
<span><span class="co">#&gt; Test loss: -3.196341 </span></span>
<span><span class="co">#&gt; = Starting epoch 222 </span></span>
<span><span class="co">#&gt; Test loss: -3.199639 </span></span>
<span><span class="co">#&gt; = Starting epoch 223 </span></span>
<span><span class="co">#&gt; Test loss: -3.217486 </span></span>
<span><span class="co">#&gt; = Starting epoch 224 </span></span>
<span><span class="co">#&gt; Test loss: -3.216756 </span></span>
<span><span class="co">#&gt; = Starting epoch 225 </span></span>
<span><span class="co">#&gt; Test loss: -3.227076 </span></span>
<span><span class="co">#&gt; = Starting epoch 226 </span></span>
<span><span class="co">#&gt; Test loss: -3.213893 </span></span>
<span><span class="co">#&gt; = Starting epoch 227 </span></span>
<span><span class="co">#&gt; Test loss: -3.222451 </span></span>
<span><span class="co">#&gt; = Starting epoch 228 </span></span>
<span><span class="co">#&gt; Test loss: -3.223485 </span></span>
<span><span class="co">#&gt; = Starting epoch 229 </span></span>
<span><span class="co">#&gt; Test loss: -3.234849 </span></span>
<span><span class="co">#&gt; = Starting epoch 230 </span></span>
<span><span class="co">#&gt; Test loss: -3.205579 </span></span>
<span><span class="co">#&gt; = Starting epoch 231 </span></span>
<span><span class="co">#&gt; Test loss: -3.226899 </span></span>
<span><span class="co">#&gt; = Starting epoch 232 </span></span>
<span><span class="co">#&gt; Test loss: -3.24866 </span></span>
<span><span class="co">#&gt; = Starting epoch 233 </span></span>
<span><span class="co">#&gt; Test loss: -3.253335 </span></span>
<span><span class="co">#&gt; = Starting epoch 234 </span></span>
<span><span class="co">#&gt; Test loss: -3.232893 </span></span>
<span><span class="co">#&gt; = Starting epoch 235 </span></span>
<span><span class="co">#&gt; Test loss: -3.233364 </span></span>
<span><span class="co">#&gt; = Starting epoch 236 </span></span>
<span><span class="co">#&gt; Test loss: -3.260592 </span></span>
<span><span class="co">#&gt; = Starting epoch 237 </span></span>
<span><span class="co">#&gt; Test loss: -3.239378 </span></span>
<span><span class="co">#&gt; = Starting epoch 238 </span></span>
<span><span class="co">#&gt; Test loss: -3.240853 </span></span>
<span><span class="co">#&gt; = Starting epoch 239 </span></span>
<span><span class="co">#&gt; Test loss: -3.25273 </span></span>
<span><span class="co">#&gt; = Starting epoch 240 </span></span>
<span><span class="co">#&gt; Test loss: -3.238631 </span></span>
<span><span class="co">#&gt; = Starting epoch 241 </span></span>
<span><span class="co">#&gt; Test loss: -3.25237 </span></span>
<span><span class="co">#&gt; = Starting epoch 242 </span></span>
<span><span class="co">#&gt; Test loss: -3.267535 </span></span>
<span><span class="co">#&gt; = Starting epoch 243 </span></span>
<span><span class="co">#&gt; Test loss: -3.228153 </span></span>
<span><span class="co">#&gt; = Starting epoch 244 </span></span>
<span><span class="co">#&gt; Test loss: -3.265316 </span></span>
<span><span class="co">#&gt; = Starting epoch 245 </span></span>
<span><span class="co">#&gt; Test loss: -3.239898 </span></span>
<span><span class="co">#&gt; = Starting epoch 246 </span></span>
<span><span class="co">#&gt; Test loss: -3.236492 </span></span>
<span><span class="co">#&gt; = Starting epoch 247 </span></span>
<span><span class="co">#&gt; Test loss: -3.246556 </span></span>
<span><span class="co">#&gt; = Starting epoch 248 </span></span>
<span><span class="co">#&gt; Test loss: -3.275096 </span></span>
<span><span class="co">#&gt; = Starting epoch 249 </span></span>
<span><span class="co">#&gt; Test loss: -3.221303 </span></span>
<span><span class="co">#&gt; = Starting epoch 250 </span></span>
<span><span class="co">#&gt; Test loss: -3.222338 </span></span>
<span><span class="co">#&gt; = Starting epoch 251 </span></span>
<span><span class="co">#&gt; Test loss: -3.254301 </span></span>
<span><span class="co">#&gt; = Starting epoch 252 </span></span>
<span><span class="co">#&gt; Test loss: -3.224986 </span></span>
<span><span class="co">#&gt; = Starting epoch 253 </span></span>
<span><span class="co">#&gt; Test loss: -3.249098 </span></span>
<span><span class="co">#&gt; = Starting epoch 254 </span></span>
<span><span class="co">#&gt; Test loss: -3.243025 </span></span>
<span><span class="co">#&gt; = Starting epoch 255 </span></span>
<span><span class="co">#&gt; Test loss: -3.210057 </span></span>
<span><span class="co">#&gt; = Starting epoch 256 </span></span>
<span><span class="co">#&gt; Test loss: -3.220776</span></span></code></pre></div>
<p>We can generate samples from the trained model as before:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate 1024 samples for each of the first 4 conditioning variables in the test set</span></span>
<span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">summarizing_flow_model</span>,</span>
<span>  <span class="fl">1024</span>,</span>
<span>  <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span>, <span class="op">]</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'mu'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'log(sigma)'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-19-1.png" width="768"></p>
<p>We can also plot the samples on a scatter plot:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">''</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">'mu'</span>, ylab <span class="op">=</span> <span class="st">'log(sigma)'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-20-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="more-complex-conditioning-variables">More complex conditioning variables<a class="anchor" aria-label="anchor" href="#more-complex-conditioning-variables"></a>
</h2>
<p>The summarizing network is the key to using more complex conditioning
variables. For example, we can use a 2D grid of points as the
conditioning variable, which is processed by the summarizing network
into a set of summary statistics which are then used as the conditioning
variable for the flow. For the 2-D grid, a convolutional network is a
conventional choice that often works well in practice.</p>
<p>The following example generates data using an exponential covariance
with unknown variance and length scale over a 16x16 2-D grid:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_grid</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">x_y_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_grid</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_grid</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">x_y_grid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">generate_conditional_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1024</span></span>
<span>  <span class="va">ell</span> <span class="op">&lt;-</span> <span class="fl">0.1</span> <span class="op">+</span> <span class="fl">1.9</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_rand.html" class="external-link">torch_rand</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_abs.html" class="external-link">torch_abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Generate the conditioning variable</span></span>
<span>  <span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_square.html" class="external-link">torch_square</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_exp.html" class="external-link">torch_exp</a></span><span class="op">(</span></span>
<span>      <span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_unsqueeze.html" class="external-link">torch_unsqueeze</a></span><span class="op">(</span><span class="va">distances</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="va">ell</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">L</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/linalg_cholesky.html" class="external-link">linalg_cholesky</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span></span>
<span>  <span class="va">y_flat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_matmul.html" class="external-link">torch_matmul</a></span><span class="op">(</span><span class="va">L</span>, <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="fl">256</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_reshape.html" class="external-link">torch_reshape</a></span><span class="op">(</span><span class="va">y_flat</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="va">n_grid</span>, <span class="va">n_grid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_log.html" class="external-link">torch_log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_stack.html" class="external-link">torch_stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ell</span>, <span class="va">sigma</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    conditioning <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">test_set</span> <span class="op">&lt;-</span> <span class="fu">generate_conditional_samples</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ target      :Float [1:1024, 1:2]</span></span>
<span><span class="co">#&gt;  $ conditioning:Float [1:1024, 1:16, 1:16]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="va">i</span>, , <span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'x'</span>, ylab <span class="op">=</span> <span class="st">'y'</span>, asp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-21-1.png" width="768"></p>
<p>We can now create a summarizing network for this conditioning
variable. A convolutional network is a conventional choice for this type
of data. The network alternates between convolution, ReLU and max
pooling layers, with a final adaptive average pooling layer to reduce
the summary statistics to a fixed size vector of dimension 32 (the
number of summary statistics used by the flow):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>  <span class="co"># Adds a unit dimension for the channel</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_unflatten.html" class="external-link">nn_unflatten</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_grid</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span>, <span class="fl">3</span>, padding <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool2d.html" class="external-link">nn_max_pool2d</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">32</span>, <span class="fl">3</span>, padding <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="co"># This averages over the grid to produce a vector of summary statistics</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_adaptive_avg_pool2d.html" class="external-link">nn_adaptive_avg_pool2d</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_flatten.html" class="external-link">nn_flatten</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">summary_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">10</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Float [1:10, 1:32]</span></span></code></pre></div>
<p>We can now create a conditional flow with this summarizing
network:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_sequential_conditional_flow.html">nn_sequential_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_permutation_flow.html">nn_permutation_flow</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/nn_affine_coupling_block.html">nn_affine_coupling_block</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">32</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">summarizing_flow_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nn_summarizing_conditional_flow.html">nn_summarizing_conditional_flow</a></span><span class="op">(</span><span class="va">summary_model</span>, <span class="va">flow_model</span><span class="op">)</span></span></code></pre></div>
<p>We can now train the model as before:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/train_conditional_flow.html">train_conditional_flow</a></span><span class="op">(</span></span>
<span>  <span class="va">summarizing_flow_model</span>,</span>
<span>  <span class="va">generate_conditional_samples</span>,</span>
<span>  n_epochs <span class="op">=</span> <span class="fl">128</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">1024</span>,</span>
<span>  after_epoch <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/forward_kl_loss.html">forward_kl_loss</a></span><span class="op">(</span><span class="fu">summarizing_flow_model</span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'Test loss:'</span>, <span class="va">test_loss</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; = Starting epoch 1 </span></span>
<span><span class="co">#&gt; Test loss: 0.7628379 </span></span>
<span><span class="co">#&gt; = Starting epoch 2 </span></span>
<span><span class="co">#&gt; Test loss: 0.6669942 </span></span>
<span><span class="co">#&gt; = Starting epoch 3 </span></span>
<span><span class="co">#&gt; Test loss: 0.5980672 </span></span>
<span><span class="co">#&gt; = Starting epoch 4 </span></span>
<span><span class="co">#&gt; Test loss: 0.5427399 </span></span>
<span><span class="co">#&gt; = Starting epoch 5 </span></span>
<span><span class="co">#&gt; Test loss: 0.4881266 </span></span>
<span><span class="co">#&gt; = Starting epoch 6 </span></span>
<span><span class="co">#&gt; Test loss: 0.4112056 </span></span>
<span><span class="co">#&gt; = Starting epoch 7 </span></span>
<span><span class="co">#&gt; Test loss: 0.3126465 </span></span>
<span><span class="co">#&gt; = Starting epoch 8 </span></span>
<span><span class="co">#&gt; Test loss: 0.2076244 </span></span>
<span><span class="co">#&gt; = Starting epoch 9 </span></span>
<span><span class="co">#&gt; Test loss: 0.1127237 </span></span>
<span><span class="co">#&gt; = Starting epoch 10 </span></span>
<span><span class="co">#&gt; Test loss: 0.03662133 </span></span>
<span><span class="co">#&gt; = Starting epoch 11 </span></span>
<span><span class="co">#&gt; Test loss: -0.03828448 </span></span>
<span><span class="co">#&gt; = Starting epoch 12 </span></span>
<span><span class="co">#&gt; Test loss: -0.1056886 </span></span>
<span><span class="co">#&gt; = Starting epoch 13 </span></span>
<span><span class="co">#&gt; Test loss: -0.1558176 </span></span>
<span><span class="co">#&gt; = Starting epoch 14 </span></span>
<span><span class="co">#&gt; Test loss: -0.2126278 </span></span>
<span><span class="co">#&gt; = Starting epoch 15 </span></span>
<span><span class="co">#&gt; Test loss: -0.1966004 </span></span>
<span><span class="co">#&gt; = Starting epoch 16 </span></span>
<span><span class="co">#&gt; Test loss: -0.2449578 </span></span>
<span><span class="co">#&gt; = Starting epoch 17 </span></span>
<span><span class="co">#&gt; Test loss: -0.2668608 </span></span>
<span><span class="co">#&gt; = Starting epoch 18 </span></span>
<span><span class="co">#&gt; Test loss: -0.2825503 </span></span>
<span><span class="co">#&gt; = Starting epoch 19 </span></span>
<span><span class="co">#&gt; Test loss: -0.3448722 </span></span>
<span><span class="co">#&gt; = Starting epoch 20 </span></span>
<span><span class="co">#&gt; Test loss: -0.3914361 </span></span>
<span><span class="co">#&gt; = Starting epoch 21 </span></span>
<span><span class="co">#&gt; Test loss: -0.4560837 </span></span>
<span><span class="co">#&gt; = Starting epoch 22 </span></span>
<span><span class="co">#&gt; Test loss: -0.507061 </span></span>
<span><span class="co">#&gt; = Starting epoch 23 </span></span>
<span><span class="co">#&gt; Test loss: -0.527684 </span></span>
<span><span class="co">#&gt; = Starting epoch 24 </span></span>
<span><span class="co">#&gt; Test loss: -0.5740682 </span></span>
<span><span class="co">#&gt; = Starting epoch 25 </span></span>
<span><span class="co">#&gt; Test loss: -0.584308 </span></span>
<span><span class="co">#&gt; = Starting epoch 26 </span></span>
<span><span class="co">#&gt; Test loss: -0.617987 </span></span>
<span><span class="co">#&gt; = Starting epoch 27 </span></span>
<span><span class="co">#&gt; Test loss: -0.6673335 </span></span>
<span><span class="co">#&gt; = Starting epoch 28 </span></span>
<span><span class="co">#&gt; Test loss: -0.6914137 </span></span>
<span><span class="co">#&gt; = Starting epoch 29 </span></span>
<span><span class="co">#&gt; Test loss: -0.7283161 </span></span>
<span><span class="co">#&gt; = Starting epoch 30 </span></span>
<span><span class="co">#&gt; Test loss: -0.6826997 </span></span>
<span><span class="co">#&gt; = Starting epoch 31 </span></span>
<span><span class="co">#&gt; Test loss: -0.7714756 </span></span>
<span><span class="co">#&gt; = Starting epoch 32 </span></span>
<span><span class="co">#&gt; Test loss: -0.8321636 </span></span>
<span><span class="co">#&gt; = Starting epoch 33 </span></span>
<span><span class="co">#&gt; Test loss: -0.8780966 </span></span>
<span><span class="co">#&gt; = Starting epoch 34 </span></span>
<span><span class="co">#&gt; Test loss: -0.912951 </span></span>
<span><span class="co">#&gt; = Starting epoch 35 </span></span>
<span><span class="co">#&gt; Test loss: -0.918989 </span></span>
<span><span class="co">#&gt; = Starting epoch 36 </span></span>
<span><span class="co">#&gt; Test loss: -0.9851421 </span></span>
<span><span class="co">#&gt; = Starting epoch 37 </span></span>
<span><span class="co">#&gt; Test loss: -1.007606 </span></span>
<span><span class="co">#&gt; = Starting epoch 38 </span></span>
<span><span class="co">#&gt; Test loss: -1.065928 </span></span>
<span><span class="co">#&gt; = Starting epoch 39 </span></span>
<span><span class="co">#&gt; Test loss: -1.066814 </span></span>
<span><span class="co">#&gt; = Starting epoch 40 </span></span>
<span><span class="co">#&gt; Test loss: -1.142631 </span></span>
<span><span class="co">#&gt; = Starting epoch 41 </span></span>
<span><span class="co">#&gt; Test loss: -1.167924 </span></span>
<span><span class="co">#&gt; = Starting epoch 42 </span></span>
<span><span class="co">#&gt; Test loss: -1.20309 </span></span>
<span><span class="co">#&gt; = Starting epoch 43 </span></span>
<span><span class="co">#&gt; Test loss: -1.223668 </span></span>
<span><span class="co">#&gt; = Starting epoch 44 </span></span>
<span><span class="co">#&gt; Test loss: -1.280639 </span></span>
<span><span class="co">#&gt; = Starting epoch 45 </span></span>
<span><span class="co">#&gt; Test loss: -1.321463 </span></span>
<span><span class="co">#&gt; = Starting epoch 46 </span></span>
<span><span class="co">#&gt; Test loss: -1.279118 </span></span>
<span><span class="co">#&gt; = Starting epoch 47 </span></span>
<span><span class="co">#&gt; Test loss: -1.365682 </span></span>
<span><span class="co">#&gt; = Starting epoch 48 </span></span>
<span><span class="co">#&gt; Test loss: -1.402282 </span></span>
<span><span class="co">#&gt; = Starting epoch 49 </span></span>
<span><span class="co">#&gt; Test loss: -1.388108 </span></span>
<span><span class="co">#&gt; = Starting epoch 50 </span></span>
<span><span class="co">#&gt; Test loss: -1.455717 </span></span>
<span><span class="co">#&gt; = Starting epoch 51 </span></span>
<span><span class="co">#&gt; Test loss: -1.506212 </span></span>
<span><span class="co">#&gt; = Starting epoch 52 </span></span>
<span><span class="co">#&gt; Test loss: -1.491447 </span></span>
<span><span class="co">#&gt; = Starting epoch 53 </span></span>
<span><span class="co">#&gt; Test loss: -1.503212 </span></span>
<span><span class="co">#&gt; = Starting epoch 54 </span></span>
<span><span class="co">#&gt; Test loss: -1.577002 </span></span>
<span><span class="co">#&gt; = Starting epoch 55 </span></span>
<span><span class="co">#&gt; Test loss: -1.583057 </span></span>
<span><span class="co">#&gt; = Starting epoch 56 </span></span>
<span><span class="co">#&gt; Test loss: -1.62386 </span></span>
<span><span class="co">#&gt; = Starting epoch 57 </span></span>
<span><span class="co">#&gt; Test loss: -1.667295 </span></span>
<span><span class="co">#&gt; = Starting epoch 58 </span></span>
<span><span class="co">#&gt; Test loss: -1.552953 </span></span>
<span><span class="co">#&gt; = Starting epoch 59 </span></span>
<span><span class="co">#&gt; Test loss: -1.524428 </span></span>
<span><span class="co">#&gt; = Starting epoch 60 </span></span>
<span><span class="co">#&gt; Test loss: -1.609413 </span></span>
<span><span class="co">#&gt; = Starting epoch 61 </span></span>
<span><span class="co">#&gt; Test loss: -1.607691 </span></span>
<span><span class="co">#&gt; = Starting epoch 62 </span></span>
<span><span class="co">#&gt; Test loss: -1.605933 </span></span>
<span><span class="co">#&gt; = Starting epoch 63 </span></span>
<span><span class="co">#&gt; Test loss: -1.692437 </span></span>
<span><span class="co">#&gt; = Starting epoch 64 </span></span>
<span><span class="co">#&gt; Test loss: -1.738144 </span></span>
<span><span class="co">#&gt; = Starting epoch 65 </span></span>
<span><span class="co">#&gt; Test loss: -1.782674 </span></span>
<span><span class="co">#&gt; = Starting epoch 66 </span></span>
<span><span class="co">#&gt; Test loss: -1.757106 </span></span>
<span><span class="co">#&gt; = Starting epoch 67 </span></span>
<span><span class="co">#&gt; Test loss: -1.808401 </span></span>
<span><span class="co">#&gt; = Starting epoch 68 </span></span>
<span><span class="co">#&gt; Test loss: -1.825903 </span></span>
<span><span class="co">#&gt; = Starting epoch 69 </span></span>
<span><span class="co">#&gt; Test loss: -1.820228 </span></span>
<span><span class="co">#&gt; = Starting epoch 70 </span></span>
<span><span class="co">#&gt; Test loss: -1.843896 </span></span>
<span><span class="co">#&gt; = Starting epoch 71 </span></span>
<span><span class="co">#&gt; Test loss: -1.87691 </span></span>
<span><span class="co">#&gt; = Starting epoch 72 </span></span>
<span><span class="co">#&gt; Test loss: -1.910702 </span></span>
<span><span class="co">#&gt; = Starting epoch 73 </span></span>
<span><span class="co">#&gt; Test loss: -1.921478 </span></span>
<span><span class="co">#&gt; = Starting epoch 74 </span></span>
<span><span class="co">#&gt; Test loss: -1.937607 </span></span>
<span><span class="co">#&gt; = Starting epoch 75 </span></span>
<span><span class="co">#&gt; Test loss: -1.972753 </span></span>
<span><span class="co">#&gt; = Starting epoch 76 </span></span>
<span><span class="co">#&gt; Test loss: -1.941202 </span></span>
<span><span class="co">#&gt; = Starting epoch 77 </span></span>
<span><span class="co">#&gt; Test loss: -1.963538 </span></span>
<span><span class="co">#&gt; = Starting epoch 78 </span></span>
<span><span class="co">#&gt; Test loss: -1.976424 </span></span>
<span><span class="co">#&gt; = Starting epoch 79 </span></span>
<span><span class="co">#&gt; Test loss: -1.99914 </span></span>
<span><span class="co">#&gt; = Starting epoch 80 </span></span>
<span><span class="co">#&gt; Test loss: -2.021092 </span></span>
<span><span class="co">#&gt; = Starting epoch 81 </span></span>
<span><span class="co">#&gt; Test loss: -1.985682 </span></span>
<span><span class="co">#&gt; = Starting epoch 82 </span></span>
<span><span class="co">#&gt; Test loss: -1.90449 </span></span>
<span><span class="co">#&gt; = Starting epoch 83 </span></span>
<span><span class="co">#&gt; Test loss: -1.550529 </span></span>
<span><span class="co">#&gt; = Starting epoch 84 </span></span>
<span><span class="co">#&gt; Test loss: -2.061322 </span></span>
<span><span class="co">#&gt; = Starting epoch 85 </span></span>
<span><span class="co">#&gt; Test loss: -1.807624 </span></span>
<span><span class="co">#&gt; = Starting epoch 86 </span></span>
<span><span class="co">#&gt; Test loss: -1.798552 </span></span>
<span><span class="co">#&gt; = Starting epoch 87 </span></span>
<span><span class="co">#&gt; Test loss: -1.908087 </span></span>
<span><span class="co">#&gt; = Starting epoch 88 </span></span>
<span><span class="co">#&gt; Test loss: -1.893756 </span></span>
<span><span class="co">#&gt; = Starting epoch 89 </span></span>
<span><span class="co">#&gt; Test loss: -1.984803 </span></span>
<span><span class="co">#&gt; = Starting epoch 90 </span></span>
<span><span class="co">#&gt; Test loss: -1.975525 </span></span>
<span><span class="co">#&gt; = Starting epoch 91 </span></span>
<span><span class="co">#&gt; Test loss: -1.959676 </span></span>
<span><span class="co">#&gt; = Starting epoch 92 </span></span>
<span><span class="co">#&gt; Test loss: -2.080962 </span></span>
<span><span class="co">#&gt; = Starting epoch 93 </span></span>
<span><span class="co">#&gt; Test loss: -2.042973 </span></span>
<span><span class="co">#&gt; = Starting epoch 94 </span></span>
<span><span class="co">#&gt; Test loss: -2.08941 </span></span>
<span><span class="co">#&gt; = Starting epoch 95 </span></span>
<span><span class="co">#&gt; Test loss: -2.059565 </span></span>
<span><span class="co">#&gt; = Starting epoch 96 </span></span>
<span><span class="co">#&gt; Test loss: -2.105437 </span></span>
<span><span class="co">#&gt; = Starting epoch 97 </span></span>
<span><span class="co">#&gt; Test loss: -2.112951 </span></span>
<span><span class="co">#&gt; = Starting epoch 98 </span></span>
<span><span class="co">#&gt; Test loss: -2.101127 </span></span>
<span><span class="co">#&gt; = Starting epoch 99 </span></span>
<span><span class="co">#&gt; Test loss: -2.188637 </span></span>
<span><span class="co">#&gt; = Starting epoch 100 </span></span>
<span><span class="co">#&gt; Test loss: -2.108054 </span></span>
<span><span class="co">#&gt; = Starting epoch 101 </span></span>
<span><span class="co">#&gt; Test loss: -2.076512 </span></span>
<span><span class="co">#&gt; = Starting epoch 102 </span></span>
<span><span class="co">#&gt; Test loss: -2.216904 </span></span>
<span><span class="co">#&gt; = Starting epoch 103 </span></span>
<span><span class="co">#&gt; Test loss: -2.200736 </span></span>
<span><span class="co">#&gt; = Starting epoch 104 </span></span>
<span><span class="co">#&gt; Test loss: -2.237848 </span></span>
<span><span class="co">#&gt; = Starting epoch 105 </span></span>
<span><span class="co">#&gt; Test loss: -2.193417 </span></span>
<span><span class="co">#&gt; = Starting epoch 106 </span></span>
<span><span class="co">#&gt; Test loss: -2.249868 </span></span>
<span><span class="co">#&gt; = Starting epoch 107 </span></span>
<span><span class="co">#&gt; Test loss: -2.256351 </span></span>
<span><span class="co">#&gt; = Starting epoch 108 </span></span>
<span><span class="co">#&gt; Test loss: -2.236518 </span></span>
<span><span class="co">#&gt; = Starting epoch 109 </span></span>
<span><span class="co">#&gt; Test loss: -2.264313 </span></span>
<span><span class="co">#&gt; = Starting epoch 110 </span></span>
<span><span class="co">#&gt; Test loss: -2.26527 </span></span>
<span><span class="co">#&gt; = Starting epoch 111 </span></span>
<span><span class="co">#&gt; Test loss: -2.281329 </span></span>
<span><span class="co">#&gt; = Starting epoch 112 </span></span>
<span><span class="co">#&gt; Test loss: -2.221788 </span></span>
<span><span class="co">#&gt; = Starting epoch 113 </span></span>
<span><span class="co">#&gt; Test loss: -2.177631 </span></span>
<span><span class="co">#&gt; = Starting epoch 114 </span></span>
<span><span class="co">#&gt; Test loss: -2.295621 </span></span>
<span><span class="co">#&gt; = Starting epoch 115 </span></span>
<span><span class="co">#&gt; Test loss: -2.289421 </span></span>
<span><span class="co">#&gt; = Starting epoch 116 </span></span>
<span><span class="co">#&gt; Test loss: -2.228275 </span></span>
<span><span class="co">#&gt; = Starting epoch 117 </span></span>
<span><span class="co">#&gt; Test loss: -2.278527 </span></span>
<span><span class="co">#&gt; = Starting epoch 118 </span></span>
<span><span class="co">#&gt; Test loss: -2.315786 </span></span>
<span><span class="co">#&gt; = Starting epoch 119 </span></span>
<span><span class="co">#&gt; Test loss: -2.262994 </span></span>
<span><span class="co">#&gt; = Starting epoch 120 </span></span>
<span><span class="co">#&gt; Test loss: -2.218856 </span></span>
<span><span class="co">#&gt; = Starting epoch 121 </span></span>
<span><span class="co">#&gt; Test loss: -2.198232 </span></span>
<span><span class="co">#&gt; = Starting epoch 122 </span></span>
<span><span class="co">#&gt; Test loss: -2.328012 </span></span>
<span><span class="co">#&gt; = Starting epoch 123 </span></span>
<span><span class="co">#&gt; Test loss: -2.28669 </span></span>
<span><span class="co">#&gt; = Starting epoch 124 </span></span>
<span><span class="co">#&gt; Test loss: -2.181582 </span></span>
<span><span class="co">#&gt; = Starting epoch 125 </span></span>
<span><span class="co">#&gt; Test loss: -2.354483 </span></span>
<span><span class="co">#&gt; = Starting epoch 126 </span></span>
<span><span class="co">#&gt; Test loss: -2.29023 </span></span>
<span><span class="co">#&gt; = Starting epoch 127 </span></span>
<span><span class="co">#&gt; Test loss: -2.089679 </span></span>
<span><span class="co">#&gt; = Starting epoch 128 </span></span>
<span><span class="co">#&gt; Test loss: -2.354216</span></span></code></pre></div>
<p>We can now generate samples from the trained model:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="fu"><a href="../reference/generate_from_conditional_flow.html">generate_from_conditional_flow</a></span><span class="op">(</span><span class="va">summarizing_flow_model</span>, <span class="fl">1024</span>, <span class="va">test_set</span><span class="op">$</span><span class="va">conditioning</span><span class="op">[</span><span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span>, , , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:1024, 1:4, 1:2] -1.078 -0.859 -0.296 0.385 -0.507 ...</span></span>
<span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/as_array.html" class="external-link">as_array</a></span><span class="op">(</span><span class="va">test_set</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'ell'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'sigma'</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="fl">32</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-25-1.png" width="768"></p>
<p>We can also plot the samples on a scatter plot:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">''</span>, xlab <span class="op">=</span> <span class="st">'ell'</span>, ylab <span class="op">=</span> <span class="st">'sigma'</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">test_target</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="torchflow_files/figure-html/unnamed-chunk-26-1.png" width="768"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Bertolacci.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
